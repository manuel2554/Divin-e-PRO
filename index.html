<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#07070A" />
  <title>Divinée — Gourmet Bar</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            divineBg: "#07070A", divineInk: "#0A0A0F", divineCream: "#F5EFE6",
            divineGold: "#C7A35C", divineGold2: "#E6D3A3",
            divinePanel: "rgba(255,255,255,0.06)", divineLine: "rgba(255,255,255,0.10)",
            divineLine2: "rgba(199,163,92,0.22)",
          },
          boxShadow: {
            divine: "0 30px 80px rgba(0,0,0,0.60)",
            glow: "0 0 0 1px rgba(199,163,92,0.18), 0 18px 60px rgba(199,163,92,0.12)",
          },
          letterSpacing: { luxe: "0.18em" },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23C7A35C' d='M32 6l7 14 15 2-11 11 3 15-14-7-14 7 3-15-11-11 15-2z'/%3E%3C/svg%3E"/>
  
  <style>
    :root { color-scheme: dark; --mx: 50vw; --my: 20vh; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #07070a; color: #f5efe6; overflow-x: hidden;
    }
    ::selection { background: rgba(199,163,92,0.35); }
    .divine-noise{ position:fixed; inset:0; pointer-events:none; opacity:.05; z-index:0; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E"); }
    .divine-spotlight{ position:fixed; inset:0; pointer-events:none; z-index:0; background: radial-gradient(700px 520px at var(--mx) var(--my), rgba(199,163,92,0.22), transparent 55%), radial-gradient(1000px 700px at 20% 35%, rgba(255,255,255,0.06), transparent 60%), radial-gradient(1200px 600px at 80% 5%, rgba(199,163,92,0.14), transparent 62%); filter:saturate(1.05); transition: background 120ms linear; }
    .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .glass{ background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); }
    .ring-gold{ box-shadow: 0 0 0 1px rgba(199,163,92,0.18), 0 24px 70px rgba(0,0,0,0.55); }
    .btn-primary{ position:relative; overflow:hidden; border-radius:16px; border:1px solid rgba(199,163,92,0.55); background: linear-gradient(135deg, rgba(199,163,92,1), rgba(230,211,163,1)); color:#07070a; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; font-size:12px; padding:12px 16px; transition: transform 160ms ease, filter 160ms ease; }
    .btn-primary::after{ content:""; position:absolute; inset:-2px; background: linear-gradient(120deg, transparent 40%, rgba(255,255,255,0.55), transparent 60%); transform: translateX(-120%); transition: transform 550ms ease; opacity:.7; }
    .btn-primary:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn-primary:hover::after{ transform: translateX(120%); }
    .btn-ghost{ border-radius:16px; border:1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.25); color: rgba(245,239,230,0.85); letter-spacing:0.18em; text-transform:uppercase; font-size:12px; padding:12px 16px; transition: border-color 160ms ease, color 160ms ease, transform 160ms ease; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .btn-ghost:hover{ border-color: rgba(199,163,92,0.55); color: rgba(199,163,92,0.95); transform: translateY(-1px); }
    .btn-disabled{ opacity:.45; filter:saturate(.6); cursor:not-allowed; }
    .nav-link{ position:relative; padding:8px 6px; }
    .nav-link::after{ content:""; position:absolute; left:6px; right:6px; bottom:2px; height:1px; background: linear-gradient(90deg, transparent, rgba(199,163,92,0.9), transparent); transform: scaleX(0); transform-origin:center; transition: transform 220ms ease; opacity:.9; }
    .nav-link:hover::after{ transform: scaleX(1); }
    .card-premium{ position:relative; overflow:hidden; }
    .card-premium::before{ content:""; position:absolute; inset:-1px; background: radial-gradient(600px 220px at 20% 0%, rgba(199,163,92,0.18), transparent 60%); opacity:0; transition: opacity 350ms ease; pointer-events:none; }
    .card-premium:hover::before{ opacity:1; }
    .card-premium::after{ content:""; position:absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,0.58), transparent 45%); opacity:0.55; pointer-events:none; }
    .hero-grid{ background: radial-gradient(1000px 500px at 10% 10%, rgba(199,163,92,0.10), transparent 60%), radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,0.06), transparent 60%), linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,0.25)); border: 1px solid rgba(255,255,255,0.08); }
    .scroll-smooth-ios{ -webkit-overflow-scrolling: touch; }
    .floating-safe{ bottom: calc(1.1rem + env(safe-area-inset-bottom)); right: calc(1.1rem + env(safe-area-inset-right)); }
    .mobile-scroll{ overflow-x:auto; -webkit-overflow-scrolling: touch; scrollbar-width:none; }
    .mobile-scroll::-webkit-scrollbar{ display:none; }
    .sheet-handle{ width:56px; height:5px; border-radius:999px; background: rgba(245,239,230,0.22); border: 1px solid rgba(199,163,92,0.22); }
    @media (prefers-reduced-motion: reduce){ .btn-primary, .btn-ghost, .nav-link::after { transition:none !important; } }
  </style>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@11/dist/framer-motion.umd.js"></script>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div class="divine-spotlight"></div>
  <div class="divine-noise"></div>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const React = window.React;
    const { useEffect, useMemo, useRef, useState } = React;

    // =========================
    // Flags / Branding
    // =========================
    const BRAND_NAME = "Divinée";
    const LOGO_LOCAL = "./assets/logo-divinee.jpg";
    const LOGO_REMOTE = "https://i.postimg.cc/J7czGY3s/Whats_App_Image_2026_02_10_at_2_42_10_PM.jpg";
    const YOGURT_ENABLED = false;

    // =========================
    // Motion fallback
    // =========================
    const FM = window.framerMotion || {};
    function stripMotionProps(props = {}) {
      const clean = { ...props };
      ["initial","animate","exit","transition","whileHover","whileInView","viewport","layout","variants","drag","dragConstraints","dragElastic","onDragEnd"].forEach((k) => delete clean[k]);
      return clean;
    }
    function createMotionFallback() {
      return new Proxy({}, {
        get: (_, tag) => (props) => {
          const { children, ...rest } = props || {};
          return React.createElement(tag, stripMotionProps(rest), children);
        }
      });
    }
    const motion = FM.motion || createMotionFallback();
    const AnimatePresence = FM.AnimatePresence || (({ children }) => React.createElement(React.Fragment, null, children));

    // =========================
    // Utils + Hooks
    // =========================
    const money = (n) => new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(n);
    function useLockBodyScroll(locked) {
      useEffect(() => {
        if (!locked) return;
        const prev = document.body.style.overflow;
        document.body.style.overflow = "hidden";
        return () => { document.body.style.overflow = prev; };
      }, [locked]);
    }
    function useEscape(handler, active = true) {
      useEffect(() => {
        if (!active) return;
        const onKeyDown = (e) => e.key === "Escape" && handler?.();
        window.addEventListener("keydown", onKeyDown);
        return () => window.removeEventListener("keydown", onKeyDown);
      }, [handler, active]);
    }
    function useSpotlight() {
      useEffect(() => {
        const root = document.documentElement;
        let raf = null;
        let tx = window.innerWidth * 0.55, ty = window.innerHeight * 0.18;
        let cx = tx, cy = ty;
        const tick = () => {
          cx += (tx - cx) * 0.12; cy += (ty - cy) * 0.12;
          root.style.setProperty("--mx", `${cx}px`); root.style.setProperty("--my", `${cy}px`);
          raf = requestAnimationFrame(tick);
        };
        const onMove = (e) => { tx = e.clientX; ty = e.clientY; };
        const onTouch = () => { tx = window.innerWidth * 0.55; ty = window.innerHeight * 0.25; };
        window.addEventListener("pointermove", onMove, { passive: true });
        window.addEventListener("touchstart", onTouch, { passive: true });
        raf = requestAnimationFrame(tick);
        return () => {
          window.removeEventListener("pointermove", onMove);
          window.removeEventListener("touchstart", onTouch);
          cancelAnimationFrame(raf);
        };
      }, []);
    }
    function useIsMobile() {
      const [isMobile, setIsMobile] = useState(() => window.innerWidth < 640);
      useEffect(() => {
        const onResize = () => setIsMobile(window.innerWidth < 640);
        window.addEventListener("resize", onResize);
        return () => window.removeEventListener("resize", onResize);
      }, []);
      return isMobile;
    }
    function useHistoryClose(active, onClose) {
      const pushedRef = useRef(false);
      useEffect(() => {
        if (!active) return;
        pushedRef.current = true;
        history.pushState({ __divineeOverlay: true }, "");
        const onPop = () => { pushedRef.current = false; onClose?.(); };
        window.addEventListener("popstate", onPop);
        return () => window.removeEventListener("popstate", onPop);
      }, [active, onClose]);
      return () => { if (pushedRef.current) { history.back(); return; } onClose?.(); };
    }

    // =========================
    // Data
    // =========================
    const burgers = [
      { id: "divinee-truffle", name: "Divinée Truffle", description: "Angus premium, crema de trufa, rúcula y brioche tostado.", price: 16.9, grams: 320, img: "https://images.unsplash.com/photo-1550547660-d9450f859349?auto=format&fit=crop&w=1600&q=80", ingredients: ["Pan brioche", "Angus 180g", "Gruyère", "Crema de trufa", "Rúcula", "Alioli Divinée"], nutrition: { kcal: 780, proteina_g: 42, carbos_g: 48, grasa_g: 46, sodio_mg: 980 }, modelUrl: "./models/burger.glb", config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"lettuce"},{type:"bunTop"}] },
      { id: "golden-smash", name: "Golden Smash", description: "Doble smash, cheddar añejado, cebolla caramelizada, pepinillos.", price: 15.5, grams: 340, img: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?auto=format&fit=crop&w=1600&q=80", ingredients: ["Potato roll", "Doble smash", "Cheddar añejado", "Cebolla caramelizada", "Pepinillos", "Salsa Divinée"], nutrition: { kcal: 860, proteina_g: 48, carbos_g: 52, grasa_g: 52, sodio_mg: 1120 }, modelUrl: "./models/burger.glb", config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"meat"},{type:"cheese"},{type:"generic"},{type:"bunTop"}] },
      { id: "noir-pepper", name: "Noir Pepper", description: "Costra de pimienta, queso azul suave, aros crujientes y demi-glace.", price: 17.25, grams: 330, img: "https://images.unsplash.com/photo-1550317138-10000687a72b?auto=format&fit=crop&w=1600&q=80", ingredients: ["Pan sésamo", "Res con pimienta", "Queso azul", "Cebolla crujiente", "Demi-glace", "Lechuga"], nutrition: { kcal: 820, proteina_g: 45, carbos_g: 44, grasa_g: 50, sodio_mg: 1040 }, modelUrl: "./models/burger.glb", config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"generic"},{type:"lettuce"},{type:"bunTop"}] },
      { id: "saffron-wagyu", name: "Saffron Wagyu", description: "Blend wagyu, alioli de azafrán, tomate confitado y toque dorado.", price: 21.9, grams: 310, img: "https://images.unsplash.com/photo-1551782450-a2132b4ba21d?auto=format&fit=crop&w=1600&q=80", ingredients: ["Pan brioche", "Blend wagyu", "Cheddar blanco", "Alioli de azafrán", "Tomate confitado", "Microgreens"], nutrition: { kcal: 790, proteina_g: 41, carbos_g: 46, grasa_g: 47, sodio_mg: 960 }, modelUrl: "./models/burger.glb", config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"tomato"},{type:"lettuce"},{type:"bunTop"}] },
      { id: "midnight-umami", name: "Midnight Umami", description: "Duxelles de hongos, glaze de soya, suizo, ajo rostizado.", price: 18.4, grams: 335, img: "https://images.unsplash.com/photo-1596662951482-0c4ba74a6df6?auto=format&fit=crop&w=1600&q=80", ingredients: ["Potato roll", "Carne premium", "Queso suizo", "Duxelles de hongos", "Ajo rostizado", "Glaze de soya"], nutrition: { kcal: 805, proteina_g: 44, carbos_g: 50, grasa_g: 48, sodio_mg: 1090 }, modelUrl: "./models/burger.glb", config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"generic"},{type:"bunTop"}] },
      { id: "velvet-chicken", name: "Velvet Chicken", description: "Pollo crispy, glaze miel-oro, ensalada col y final cítrico.", price: 14.75, grams: 360, img: "https://images.unsplash.com/photo-1606755962773-d324e0a13086?auto=format&fit=crop&w=1600&q=80", ingredients: ["Pan brioche", "Pollo crispy", "Glaze miel-oro", "Coleslaw", "Pepinillos", "Alioli limón"], nutrition: { kcal: 740, proteina_g: 39, carbos_g: 58, grasa_g: 38, sodio_mg: 980 }, modelUrl: "./models/burger.glb", config: [{type:"bunBottom"},{type:"meat"},{type:"generic"},{type:"bunTop"}] },
    ];
    const desserts = [
      { id: "noir-cheesecake", name: "Noir Cheesecake", description: "Cheesecake sedoso con cacao oscuro y crumble de avellana.", price: 9.5, img: "https://images.unsplash.com/photo-1541781408260-3c7b8d7a5b61?auto=format&fit=crop&w=1600&q=80" },
      { id: "gold-mousse", name: "Gold Mousse", description: "Mousse de vainilla de Madagascar con brillo dorado sutil.", price: 10.25, img: "https://images.unsplash.com/photo-1601972602237-8c79241e468b?auto=format&fit=crop&w=1600&q=80" },
      { id: "creme-brulee-tart", name: "Tarta Crème Brûlée", description: "Caramelo flameado, núcleo de crema y base mantequilla.", price: 10.75, img: "https://images.unsplash.com/photo-1608198093002-ad4e005484ec?auto=format&fit=crop&w=1600&q=80" },
      { id: "pistachio-opera", name: "Ópera de Pistacho", description: "Capas de pistacho con notas de espresso y glaseado satinado.", price: 11.5, img: "https://images.unsplash.com/photo-1589308078059-be1415eab4c3?auto=format&fit=crop&w=1600&q=80" },
    ];

    // =========================
    // Three helpers
    // =========================
    function makeNoiseTexture(THREE, { size = 256, contrast = 0.6 } = {}) {
      const c = document.createElement("canvas"); c.width = c.height = size;
      const ctx = c.getContext("2d", { willReadFrequently: true });
      const img = ctx.createImageData(size, size);
      for (let i = 0; i < img.data.length; i += 4) {
        const v = Math.floor(120 + (Math.random() - 0.5) * 255 * contrast);
        img.data[i] = v; img.data[i + 1] = v; img.data[i + 2] = v; img.data[i + 3] = 255;
      }
      ctx.putImageData(img, 0, 0);
      const tex = new THREE.CanvasTexture(c);
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping; tex.repeat.set(3, 3); tex.needsUpdate = true;
      return tex;
    }
    function fitCameraToObject(THREE, camera, object, offset = 1.4) {
      const box = new THREE.Box3().setFromObject(object);
      if (box.isEmpty()) return;
      const size = new THREE.Vector3(); const center = new THREE.Vector3();
      box.getSize(size); box.getCenter(center);
      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      const cameraZ = Math.abs((maxDim / 2) / Math.tan(fov / 2)) * offset;
      camera.position.set(center.x, center.y + maxDim * 0.20, center.z + cameraZ);
      camera.lookAt(center); camera.updateProjectionMatrix();
    }
    // =========================
    // Components
    // =========================
    function Header({ onNavigate, onOpenCart, cartCount }) {
      const [logoSrc, setLogoSrc] = useState(LOGO_LOCAL);
      const NavChip = ({ label, enabled, onClick }) => (
        <button disabled={!enabled} onClick={enabled ? onClick : undefined} className={["whitespace-nowrap rounded-full border px-4 py-2 text-[11px] tracking-[0.22em] backdrop-blur transition", enabled ? "border-divineLine2 bg-black/25 text-divineCream/75 hover:text-divineGold hover:border-divineGold/40" : "border-divineLine2 bg-black/20 text-divineCream/40 btn-disabled"].join(" ")} type="button">{label}</button>
      );
      return (
        <header className="fixed left-0 top-0 z-40 w-full">
          <div className="mx-auto max-w-6xl px-4 md:px-6">
            <div className="mt-3 rounded-2xl glass ring-gold" style={{ paddingTop: "env(safe-area-inset-top)" }}>
              <div className="flex items-center justify-between gap-3 px-4 py-3 md:px-6">
                <div className="flex items-center gap-3 min-w-0">
                  <div className="rounded-xl border border-divineLine2 bg-black/25 p-2 shadow-glow">
                    <img src={logoSrc} alt={BRAND_NAME} className="h-8 w-auto object-contain" loading="eager" decoding="async" onError={() => { if (logoSrc !== LOGO_REMOTE) setLogoSrc(LOGO_REMOTE); }} />
                  </div>
                  <div className="hidden md:block min-w-0">
                    <div className="text-xs tracking-luxe text-divineGold/95">{BRAND_NAME.toUpperCase()}</div>
                    <div className="text-[10px] tracking-[0.35em] text-divineCream/60">GOURMET BAR</div>
                  </div>
                </div>
                <nav className="hidden md:flex items-center gap-4 text-xs tracking-[0.22em] text-divineCream/80">
                  <button onClick={() => onNavigate("burgers")} className="nav-link hover:text-divineGold transition" type="button">HAMBURGUESAS</button>
                  <button onClick={() => onNavigate("desserts")} className="nav-link hover:text-divineGold transition" type="button">POSTRES</button>
                  <button disabled={!YOGURT_ENABLED} onClick={YOGURT_ENABLED ? () => onNavigate("yogurt") : undefined} className={["nav-link transition", YOGURT_ENABLED ? "hover:text-divineGold" : "btn-disabled text-divineCream/50"].join(" ")} type="button">YOGURT {YOGURT_ENABLED ? "" : "• PRONTO"}</button>
                  <button onClick={() => onNavigate("atelier")} className="nav-link hover:text-divineGold transition" type="button">ATELIER</button>
                </nav>
                <div className="flex items-center gap-2">
                  <button onClick={onOpenCart} className="btn-ghost px-4 py-2" type="button">CARRITO {cartCount > 0 ? `(${cartCount})` : ""}</button>
                </div>
              </div>
              <div className="md:hidden px-4 pb-3">
                <div className="mobile-scroll flex gap-2">
                  <NavChip label="HAMBURGUESAS" enabled={true} onClick={() => onNavigate("burgers")} />
                  <NavChip label="POSTRES" enabled={true} onClick={() => onNavigate("desserts")} />
                  <NavChip label="YOGURT • PRONTO" enabled={false} onClick={() => {}} />
                  <NavChip label="ATELIER" enabled={true} onClick={() => onNavigate("atelier")} />
                </div>
              </div>
            </div>
          </div>
        </header>
      );
    }
    function SectionShell({ eyebrow, title, subtitle, children }) {
      return (
        <div className="mb-10 md:mb-16">
          <motion.div initial={{ opacity: 0, y: 14 }} whileInView={{ opacity: 1, y: 0 }} viewport={{ amount: 0.25, once: true }} transition={{ duration: 0.6, ease: [0.2, 0.8, 0.2, 1] }} className="mb-4 md:mb-7">
            <div className="mb-2 text-xs tracking-[0.35em] text-divineGold/90">{eyebrow}</div>
            <h2 className="text-2xl font-semibold md:text-4xl">{title}</h2>
            <p className="mt-2 max-w-2xl text-sm text-divineCream/70 md:text-base">{subtitle}</p>
          </motion.div>
          {children}
        </div>
      );
    }
    function ProductCard({ product, badge, onClick, onAdd }) {
      return (
        <motion.div whileHover={{ y: -6 }} transition={{ type: "spring", stiffness: 260, damping: 22 }} className="group overflow-hidden rounded-2xl border border-divineLine bg-divinePanel shadow-divine">
          <button onClick={onClick} className="block w-full text-left" type="button">
            <div className="relative aspect-[4/3] overflow-hidden card-premium">
              <img src={product.img} alt={product.name} className="h-full w-full object-cover transition duration-700 group-hover:scale-[1.08]" loading="lazy" />
              <div className="absolute left-3 top-3 rounded-full border border-divineLine2 bg-black/35 px-3 py-1 text-[10px] tracking-[0.28em] text-divineCream/85 backdrop-blur">{badge}</div>
              <div className="absolute right-3 top-3 rounded-full border border-divineLine2 bg-black/35 px-3 py-1 text-[10px] tracking-[0.12em] text-divineGold/95 backdrop-blur">{money(product.price)}</div>
            </div>
            <div className="p-4">
              <div className="text-base font-semibold">{product.name}</div>
              <div className="mt-1 text-sm text-divineCream/70 line-clamp-2">{product.description}</div>
              <div className="mt-4 flex items-center justify-between gap-3">
                <span className="text-xs tracking-[0.22em] text-divineCream/55">{BRAND_NAME.toUpperCase()}</span>
                <button onClick={(e) => { e.preventDefault(); e.stopPropagation(); onAdd?.(); }} className="rounded-xl border border-divineLine2 bg-black/25 px-3 py-2 text-xs tracking-[0.22em] text-divineCream/80 hover:bg-black/35 hover:text-divineGold hover:border-divineGold/50 transition" type="button">AÑADIR</button>
              </div>
            </div>
          </button>
        </motion.div>
      );
    }
    function ProductShowcase({ items, badge, onOpen, onAdd }) {
      return (
        <>
          <div className="sm:hidden">
            <div className="mobile-scroll flex gap-3 pb-2 snap-x snap-mandatory">
              {items.map((p) => (
                <div key={p.id} className="w-[78vw] max-w-[360px] snap-start">
                  <ProductCard product={p} badge={badge} onClick={() => onOpen(p)} onAdd={() => onAdd({ id: p.id, name: p.name, price: p.price })} />
                </div>
              ))}
            </div>
            <p className="mt-2 text-xs text-divineCream/50">Desliza horizontal para ver más.</p>
          </div>
          <div className="hidden sm:grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {items.map((p) => (
              <ProductCard key={p.id} product={p} badge={badge} onClick={() => onOpen(p)} onAdd={() => onAdd({ id: p.id, name: p.name, price: p.price })} />
            ))}
          </div>
        </>
      );
    }

    // =========================
    // 3D Viewer Mejorado (Cae con Físicas y Dinámico)
    // =========================
    function BurgerViewer3D({ heightClass = "h-[280px] md:h-[440px]", modelUrl, showUI = true, burgerConfig = null }) {
      const mountRef = useRef(null);
      const reqRef = useRef(null);
      const stateRef = useRef({ THREE: null, scene: null, camera: null, renderer: null, root: null, stack: null, animatables: [], matCache: null });
      const [err, setErr] = useState(null);
      const [autoRotate, setAutoRotate] = useState(true);
      
      const yawRef = useRef(0);
      const pitchRef = useRef(-0.12);
      const draggingRef = useRef(false);
      const lastRef = useRef({ x: 0, y: 0 });
      const autoRotateRef = useRef(true);
      useEffect(() => { autoRotateRef.current = autoRotate; }, [autoRotate]);

      // 1. Setup inicial del motor (una sola vez)
      useEffect(() => {
        try {
          const THREE = window.THREE;
          if (!THREE) throw new Error("Three.js no se cargó.");
          const mount = mountRef.current;
          if (!mount) return;

          const getSize = () => {
            const r = mount.getBoundingClientRect();
            return { w: Math.max(1, Math.floor(r.width)), h: Math.max(1, Math.floor(r.height)) };
          };
          const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
          renderer.outputColorSpace = THREE.SRGBColorSpace;
          renderer.toneMapping = THREE.ACESFilmicToneMapping;
          renderer.toneMappingExposure = 1.2;
          renderer.shadowMap.enabled = true;
          renderer.shadowMap.type = THREE.PCFSoftShadowMap;

          const { w, h } = getSize();
          renderer.setSize(w, h);
          renderer.domElement.style.width = "100%";
          renderer.domElement.style.height = "100%";
          renderer.domElement.style.display = "block";
          renderer.domElement.style.touchAction = "none";
          mount.appendChild(renderer.domElement);

          const scene = new THREE.Scene();
          scene.fog = new THREE.Fog(0x0a0a0f, 8, 18);
          const camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 100);

          scene.add(new THREE.AmbientLight(0xffffff, 0.16));
          scene.add(new THREE.HemisphereLight(0xf5efe6, 0x07070a, 0.60));
          const key = new THREE.SpotLight(0xffffff, 2.3, 30, Math.PI / 6, 0.35, 1.2);
          key.position.set(4.5, 6.0, 3.2); key.castShadow = true; key.shadow.mapSize.set(1024, 1024);
          scene.add(key);
          const rim = new THREE.DirectionalLight(0xc7a35c, 0.85); rim.position.set(-4.0, 2.2, -3.2); scene.add(rim);
          const fill = new THREE.DirectionalLight(0xe6d3a3, 0.55); fill.position.set(-4.2, 2.2, 2.5); scene.add(fill);

          const ground = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), new THREE.ShadowMaterial({ opacity: 0.20 }));
          ground.rotation.x = -Math.PI / 2; ground.position.y = -1.25; ground.receiveShadow = true;
          scene.add(ground);

          const root = new THREE.Group();
          root.position.set(0, -0.2, 0); // Mejor centrado vertical
          scene.add(root);
          const stack = new THREE.Group();
          root.add(stack);

          // Controladores de giro
          const el = renderer.domElement;
          const onDown = (e) => { draggingRef.current = true; lastRef.current = { x: e.clientX, y: e.clientY }; el.setPointerCapture?.(e.pointerId); };
          const onMove = (e) => {
            if (!draggingRef.current) return;
            const dx = e.clientX - lastRef.current.x; const dy = e.clientY - lastRef.current.y;
            lastRef.current = { x: e.clientX, y: e.clientY };
            yawRef.current += dx * 0.008; pitchRef.current += dy * 0.006;
            pitchRef.current = Math.max(-0.75, Math.min(0.35, pitchRef.current));
          };
          const onUp = (e) => { draggingRef.current = false; try { el.releasePointerCapture?.(e.pointerId); } catch {} };
          el.addEventListener("pointerdown", onDown, { passive: true });
          el.addEventListener("pointermove", onMove, { passive: true });
          window.addEventListener("pointerup", onUp, { passive: true });

          const onResize = () => { const { w: nw, h: nh } = getSize(); camera.aspect = nw / nh; camera.updateProjectionMatrix(); renderer.setSize(nw, nh); };
          window.addEventListener("resize", onResize);

          // Cache de materiales para optimizar
          const bunNoise = makeNoiseTexture(THREE, { contrast: 0.45 });
          const meatNoise = makeNoiseTexture(THREE, { contrast: 0.65 });
          const matCache = {
            bun: new THREE.MeshPhysicalMaterial({ color: 0xc7a35c, roughness: 0.55, bumpMap: bunNoise, bumpScale: 0.08 }),
            meat: new THREE.MeshStandardMaterial({ color: 0x341b12, roughness: 0.92, bumpMap: meatNoise, bumpScale: 0.14 }),
            cheese: new THREE.MeshPhysicalMaterial({ color: 0xf2c24f, roughness: 0.38, clearcoat: 0.25 }),
            green: new THREE.MeshStandardMaterial({ color: 0x3f8f5a, roughness: 0.85 }),
            red: new THREE.MeshStandardMaterial({ color: 0xb33b2e, roughness: 0.68 }),
            generic: new THREE.MeshStandardMaterial({ color: 0x8a6a4c, roughness: 0.9 })
          };

          stateRef.current = { THREE, scene, camera, renderer, root, stack, animatables: [], matCache };

          const animate = () => {
            reqRef.current = requestAnimationFrame(animate);
            if (stateRef.current.root) {
              if (autoRotateRef.current && !draggingRef.current) yawRef.current += 0.0032;
              stateRef.current.root.rotation.y = yawRef.current;
              stateRef.current.root.rotation.x = pitchRef.current;
            }
            // Físicas de caída (Resorte)
            const time = performance.now() * 0.001;
            stateRef.current.animatables.forEach(item => {
              if (time > item.startTime) {
                const diff = item.targetY - item.mesh.position.y;
                item.velocity += diff * 0.25; // Rigidez del resorte
                item.velocity *= 0.65; // Amortiguación
                item.mesh.position.y += item.velocity;
              }
            });
            renderer.render(scene, camera);
          };
          animate();

          return () => {
            window.removeEventListener("resize", onResize);
            el.removeEventListener("pointerdown", onDown); el.removeEventListener("pointermove", onMove); window.removeEventListener("pointerup", onUp);
            cancelAnimationFrame(reqRef.current);
            renderer.dispose();
            if (mount.contains(renderer.domElement)) mount.removeChild(renderer.domElement);
            stateRef.current = { animatables: [] };
          };
        } catch (e) { setErr(e?.message || String(e)); }
      }, []);

      // 2. Manejador dinámico de ingredientes
      useEffect(() => {
        const st = stateRef.current;
        if (!st.THREE || !st.stack) return;
        const { THREE, stack, camera, matCache } = st;

        // Limpiamos la hamburguesa anterior
        while (stack.children.length) stack.remove(stack.children[0]);
        st.animatables = [];

        // Base por defecto si no hay config
        const fallbackConfig = [{ type: 'bunBottom' }, { type: 'meat' }, { type: 'cheese' }, { type: 'lettuce' }, { type: 'tomato' }, { type: 'bunTop' }];
        const currentConfig = burgerConfig || fallbackConfig;

        if (modelUrl && THREE.GLTFLoader) {
          const loader = new THREE.GLTFLoader();
          loader.load(modelUrl, (gltf) => {
            const model = gltf.scene;
            model.traverse((o) => { if (o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
            model.scale.setScalar(1.2);
            // La prearmada entera cae
            model.position.y = 5;
            st.animatables.push({ mesh: model, targetY: 0, startTime: performance.now() * 0.001, velocity: 0 });
            stack.add(model);
            
            model.position.y = 0; // Fake target para calcular centro de camara
            fitCameraToObject(THREE, camera, stack, 1.4);
            model.position.y = 5; // Reset a cielo
          }, undefined, () => buildProcedural(currentConfig));
        } else {
          buildProcedural(currentConfig);
        }

        function buildProcedural(config) {
          let currentY = -0.5; // Empezar de más abajo para mejor centro visual
          const anims = [];
          const now = performance.now() * 0.001;

          config.forEach((item, idx) => {
            let mesh, thickness;
            if (item.type === 'bunBottom') { mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.92, 1.02, 0.26, 64), matCache.bun); thickness = 0.26; }
            else if (item.type === 'meat') { mesh = new THREE.Mesh(new THREE.CylinderGeometry(1.04, 1.04, 0.28, 64), matCache.meat); thickness = 0.28; }
            else if (item.type === 'cheese') { mesh = new THREE.Mesh(new THREE.CylinderGeometry(1.07, 1.07, 0.08, 64), matCache.cheese); thickness = 0.08; }
            else if (item.type === 'lettuce') { mesh = new THREE.Mesh(new THREE.TorusGeometry(0.78, 0.12, 14, 90), matCache.green); mesh.rotation.x = Math.PI / 2; thickness = 0.15; }
            else if (item.type === 'tomato') {
              mesh = new THREE.Group();
              for (let i = 0; i < 3; i++) {
                const t = new THREE.Mesh(new THREE.CylinderGeometry(0.28, 0.28, 0.06, 48), matCache.red);
                t.position.set(Math.cos(i * 2.2) * 0.45, 0, Math.sin(i * 2.2) * 0.45);
                mesh.add(t);
              }
              thickness = 0.06;
            } else if (item.type === 'bunTop') { mesh = new THREE.Mesh(new THREE.SphereGeometry(0.95, 64, 48, 0, Math.PI * 2, 0, Math.PI / 1.9), matCache.bun); mesh.scale.set(1.0, 0.62, 1.0); thickness = 0.4; }
            else { mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.85, 0.85, 0.05, 32), matCache.generic); thickness = 0.05; }

            if (mesh) {
              mesh.traverse((m) => { if(m.isMesh){ m.castShadow = true; m.receiveShadow = true; }});
              stack.add(mesh);
              const targetY = currentY + thickness / 2;
              mesh.position.y = targetY; // set temporal para la cámara
              anims.push({ mesh, targetY, startTime: now + idx * 0.15, velocity: 0 });
              currentY += thickness;
            }
          });

          // Ajustamos cámara con las piezas en su sitio final
          fitCameraToObject(THREE, camera, stack, 1.4);
          
          // Elevamos las piezas al cielo para que caigan una por una!
          anims.forEach(a => { a.mesh.position.y = a.targetY + 6; });
          st.animatables = anims;
        }
      }, [modelUrl, burgerConfig]);

      if (err) return (<div className={`${heightClass} w-full rounded-2xl border border-divineLine bg-black/20 p-4`}><div className="text-xs tracking-[0.28em] text-divineGold/90">3D</div><div className="mt-2 text-sm text-divineCream/70">{err}</div></div>);

      return (
        <div className="relative w-full">
          {showUI && <div className="absolute left-3 top-3 z-10 rounded-full border border-divineLine2 bg-black/35 px-3 py-1 text-[10px] tracking-[0.28em] text-divineCream/85 backdrop-blur">360° (ARRASTRA)</div>}
          {showUI && (
            <div className="absolute bottom-3 left-3 z-10 flex gap-2">
              <button onClick={() => setAutoRotate((s) => !s)} className="btn-ghost py-2 px-4" type="button">{autoRotate ? "PAUSAR" : "AUTO"}</button>
              <button onClick={() => { yawRef.current = 0; pitchRef.current = -0.12; }} className="btn-ghost py-2 px-4" type="button">REINICIAR</button>
            </div>
          )}
          <div ref={mountRef} className={`${heightClass} w-full bg-gradient-to-b from-black/0 to-black/35`}></div>
        </div>
      );
    }
    // =========================
    // Modales y Carrito
    // =========================
    function BottomSheet({ title, subtitle, onClose, children, cta }) {
      const close = useHistoryClose(true, onClose); useEscape(close, true);
      return (
        <motion.div className="fixed inset-0 z-50" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/70" onClick={close}></div>
          <motion.div initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }} transition={{ type: "spring", stiffness: 260, damping: 28 }} drag="y" dragConstraints={{ top: 0, bottom: 0 }} dragElastic={0.18} onDragEnd={(e, info) => { if ((info?.offset?.y ?? 0) > 120 || (info?.velocity?.y ?? 0) > 900) close(); }} className="absolute left-0 right-0 bottom-0 rounded-t-3xl border border-divineLine2 bg-divineInk shadow-divine" style={{ paddingBottom: "calc(0.75rem + env(safe-area-inset-bottom))" }} onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-center pt-3"><div className="sheet-handle"></div></div>
            <div className="px-4 pt-3 pb-3 border-b border-divineLine2 bg-black/20 backdrop-blur">
              <div className="flex items-start justify-between gap-3">
                <div className="min-w-0"><div className="text-[10px] tracking-[0.35em] text-divineGold/90">{title}</div>{subtitle && <div className="mt-1 text-sm text-divineCream/80 truncate">{subtitle}</div>}</div>
                <button className="btn-ghost py-2 px-4" onClick={close} type="button">✕ CERRAR</button>
              </div>
            </div>
            <div className="max-h-[72vh] overflow-y-auto scroll-smooth-ios overscroll-contain px-4 py-4">{children}</div>
            {cta && <div className="px-4 pt-2">{cta}</div>}
          </motion.div>
        </motion.div>
      );
    }
    function ProductModal({ product, onClose, onAdd }) {
      const isMobile = useIsMobile(); useLockBodyScroll(true);
      const viewer = <BurgerViewer3D heightClass={isMobile ? "h-[240px]" : "h-[360px] lg:h-[520px]"} modelUrl={product.modelUrl} burgerConfig={product.config} showUI={true} />;
      
      if (isMobile) {
        return (
          <BottomSheet title="COLECCIÓN DIVINÉE" subtitle={product.name} onClose={onClose} cta={<button onClick={onAdd} className="w-full btn-primary" type="button">AÑADIR AL CARRITO · {money(product.price)}</button>}>
            <div className="rounded-2xl border border-divineLine2 bg-black/20 overflow-hidden">{viewer}</div>
            <div className="mt-4 text-sm text-divineCream/70">{product.description}</div>
            <div className="mt-3 flex flex-wrap items-center gap-2"><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Peso: <span className="text-divineCream">{product.grams}g</span></span><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Precio: <span className="text-divineGold font-semibold">{money(product.price)}</span></span></div>
            <div className="mt-4 rounded-2xl border border-divineLine2 bg-divinePanel p-4"><div className="text-xs tracking-[0.28em] text-divineCream/60">INGREDIENTES</div><ul className="mt-3 space-y-2 text-sm text-divineCream/75">{product.ingredients?.map((ing) => (<li key={ing} className="flex items-center justify-between"><span>{ing}</span><span className="text-divineGold/60">•</span></li>))}</ul></div>
          </BottomSheet>
        );
      }
      const close = useHistoryClose(true, onClose); useEscape(close, true);
      return (
        <motion.div className="fixed inset-0 z-50" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/70" onClick={close}></div>
          <div className="absolute inset-0 flex items-center justify-center p-4 md:p-6">
            <motion.div initial={{ y: 18, opacity: 0, scale: 0.99 }} animate={{ y: 0, opacity: 1, scale: 1 }} exit={{ y: 14, opacity: 0, scale: 0.99 }} transition={{ duration: 0.28, ease: [0.2, 0.8, 0.2, 1] }} className="relative w-full max-w-5xl max-h-[92vh] overflow-hidden rounded-3xl border border-divineLine2 bg-divineInk shadow-divine" onClick={(e) => e.stopPropagation()}>
              <div className="sticky top-0 z-20 border-b border-divineLine2 bg-black/35 backdrop-blur px-5 py-3"><div className="flex items-center justify-between gap-3"><div className="min-w-0"><div className="text-[10px] tracking-[0.35em] text-divineGold/90">COLECCIÓN DIVINÉE</div><div className="truncate text-sm font-semibold text-divineCream">{product.name}</div></div><button onClick={close} className="btn-ghost py-2 px-4" type="button">✕ CERRAR</button></div></div>
              <div className="max-h-[92vh] overflow-y-auto scroll-smooth-ios overscroll-contain"><div className="grid grid-cols-1 lg:grid-cols-2"><div className="relative p-5"><div className="rounded-2xl border border-divineLine2 bg-black/20 overflow-hidden">{viewer}</div></div><div className="p-5 lg:p-7"><h3 className="text-2xl font-semibold">{product.name}</h3><p className="mt-2 text-sm text-divineCream/70">{product.description}</p><div className="mt-5 flex flex-wrap items-center gap-3"><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Peso: <span className="text-divineCream">{product.grams}g</span></span><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Precio: <span className="text-divineGold font-semibold">{money(product.price)}</span></span><button onClick={onAdd} className="ml-auto btn-primary" type="button">AÑADIR</button></div><div className="mt-6 rounded-2xl border border-divineLine2 bg-divinePanel p-4"><div className="text-xs tracking-[0.28em] text-divineCream/60">INGREDIENTES</div><ul className="mt-3 space-y-2 text-sm text-divineCream/75">{product.ingredients?.map((ing) => (<li key={ing} className="flex items-center justify-between"><span>{ing}</span><span className="text-divineGold/60">•</span></li>))}</ul></div><div className="mt-6 rounded-2xl border border-divineLine2 bg-black/25 p-4"><div className="text-xs tracking-[0.28em] text-divineCream/60">NUTRICIÓN</div><div className="mt-3 grid grid-cols-2 gap-3 text-sm">{Object.entries(product.nutrition || {}).map(([k, v]) => (<div key={k} className="flex items-center justify-between rounded-xl border border-divineLine bg-divinePanel px-3 py-2"><span className="text-divineCream/70">{String(k).toUpperCase()}</span><span className="font-semibold text-divineCream">{v}</span></div>))}</div></div><div className="h-4"></div></div></div></div>
            </motion.div>
          </div>
        </motion.div>
      );
    }
    function CartButton({ cartCount, onClick }) {
      return (
        <button onClick={onClick} className="fixed z-40 rounded-2xl border border-divineLine2 bg-black/35 px-4 py-3 shadow-glow backdrop-blur hover:brightness-110 transition floating-safe" aria-label="Abrir carrito" type="button"><div className="flex items-center gap-3"><div className="text-xs tracking-[0.28em] text-divineCream/75">CARRITO</div><div className="rounded-full bg-divineGold px-2 py-1 text-xs font-semibold text-black">{cartCount}</div></div></button>
      );
    }
    function CartDrawer({ items, total, onClose, onQty }) {
      useLockBodyScroll(true); const close = useHistoryClose(true, onClose); useEscape(close, true);
      return (
        <motion.div className="fixed inset-0 z-50" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/70" onClick={close}></div>
          <motion.aside initial={{ x: 24, opacity: 0 }} animate={{ x: 0, opacity: 1 }} exit={{ x: 24, opacity: 0 }} transition={{ duration: 0.28, ease: [0.2, 0.8, 0.2, 1] }} className="absolute right-0 top-0 h-full w-[92vw] max-w-md border-l border-divineLine2 bg-divineInk shadow-divine" onClick={(e) => e.stopPropagation()}>
            <div className="h-full overflow-y-auto scroll-smooth-ios overscroll-contain p-5 pb-10" style={{ paddingBottom: "calc(2.5rem + env(safe-area-inset-bottom))" }}><div className="flex items-start justify-between"><div><div className="text-xs tracking-[0.35em] text-divineGold/90">{BRAND_NAME.toUpperCase()}</div><h3 className="mt-2 text-xl font-semibold">Carrito</h3><p className="mt-1 text-sm text-divineCream/60">Revisa y ajusta cantidades.</p></div><button onClick={close} className="btn-ghost py-2 px-4" type="button">CERRAR</button></div><div className="mt-6 space-y-3">{items.length === 0 ? (<div className="rounded-2xl border border-divineLine bg-divinePanel p-4 text-sm text-divineCream/70">Tu carrito está vacío.</div>) : (items.map((it) => (<div key={it.id} className="rounded-2xl border border-divineLine2 bg-divinePanel p-4"><div className="flex items-start justify-between gap-3"><div><div className="font-semibold">{it.name}</div><div className="mt-1 text-sm text-divineCream/70">{money(it.price)}</div>{it.meta && (<div className="mt-2 text-xs text-divineCream/55">{Object.entries(it.meta).map(([k, v]) => (<div key={k}><span className="text-divineGold/80">{k}:</span> <span>{Array.isArray(v) ? v.join(", ") : String(v)}</span></div>))}</div>)}</div><div className="text-sm font-semibold text-divineGold">{money(it.price * it.qty)}</div></div><div className="mt-3 flex items-center gap-2"><button className="btn-ghost py-2 px-4" onClick={() => onQty(it.id, it.qty - 1)} type="button">−</button><div className="min-w-10 text-center text-sm">{it.qty}</div><button className="btn-ghost py-2 px-4" onClick={() => onQty(it.id, it.qty + 1)} type="button">+</button><button className="ml-auto btn-ghost py-2 px-4" onClick={() => onQty(it.id, 0)} type="button">ELIMINAR</button></div></div>)))}</div><div className="mt-6 rounded-2xl border border-divineLine2 bg-black/25 p-4"><div className="flex items-center justify-between"><span className="text-sm text-divineCream/70">Total</span><span className="text-lg font-semibold text-divineGold">{money(total)}</span></div><button className="mt-4 w-full btn-primary" disabled={items.length === 0} style={{ opacity: items.length ? 1 : 0.6 }} type="button">PAGAR</button></div></div>
          </motion.aside>
        </motion.div>
      );
    }

// =========================
    // Atelier (Burger Builder)
    // =========================
    const BURGER_BASE = 2.95;
    const BURGER_CATALOG = {
      buns: [
        { id: "brioche", name: "Brioche", price: 1.75, note: "Suave, dorado, premium" },
        { id: "potato", name: "Potato Roll", price: 1.50, note: "Esponjoso, balanceado" },
        { id: "sesame", name: "Sésamo", price: 1.25, note: "Clásico, crujiente" },
        { id: "pretzel", name: "Pretzel", price: 1.95, note: "Más denso, elegante" },
        { id: "ciabatta", name: "Ciabatta", price: 1.85, note: "Textura artesanal" },
        { id: "lettuce", name: "Lettuce Wrap", price: 0.95, note: "Fresco, low-carb" },
      ],
      proteins: [
        { id: "angus180", name: "Angus 180g", price: 7.25, note: "Jugosa y potente" },
        { id: "smash", name: "Smash 120g", price: 5.25, note: "Corte caramelizado" },
        { id: "wagyuBlend", name: "Wagyu Blend", price: 9.50, note: "Ultra premium" },
        { id: "chickenCrispy", name: "Pollo Crispy", price: 6.90, note: "Crujiente perfecto" },
        { id: "chickenGrilled", name: "Pollo Grilled", price: 6.50, note: "Más ligero" },
        { id: "plant", name: "Plant-based", price: 7.10, note: "Sabor moderno" },
        { id: "lamb", name: "Cordero", price: 8.40, note: "Gourmet intenso" },
      ],
      cheeses: [
        { id: "cheddar", name: "Cheddar Añejo", price: 1.35, note: "Clásico lujo" },
        { id: "gruyere", name: "Gruyère", price: 1.75, note: "Nuez y crema" },
        { id: "swiss", name: "Suizo", price: 1.50, note: "Suave, elástico" },
        { id: "blue", name: "Azul Suave", price: 1.95, note: "Umami elegante" },
        { id: "pepperJack", name: "Pepper Jack", price: 1.65, note: "Picante sutil" },
        { id: "none", name: "Sin queso", price: 0.0, note: "Limpio, directo" },
      ],
      toppings: [
        { id: "bacon", name: "Bacon premium", price: 2.00, group: "Crunch" },
        { id: "pickles", name: "Pepinillos", price: 0.70, group: "Classic" },
        { id: "lettuce", name: "Lechuga", price: 0.60, group: "Fresh" },
        { id: "arugula", name: "Rúcula", price: 0.85, group: "Fresh" },
        { id: "tomato", name: "Tomate", price: 0.65, group: "Fresh" },
        { id: "mushrooms", name: "Hongos salteados", price: 1.25, group: "Umami" },
        { id: "caramelOnion", name: "Cebolla caramelizada", price: 1.10, group: "Classic" },
        { id: "crispyOnion", name: "Cebolla crujiente", price: 1.05, group: "Crunch" },
        { id: "egg", name: "Huevo", price: 1.60, group: "Luxe" },
        { id: "avocado", name: "Aguacate", price: 1.80, group: "Luxe" },
        { id: "hashbrown", name: "Hashbrown", price: 1.90, group: "Crunch" },
        { id: "divineeSauce", name: "Salsa Divinée", price: 1.00, group: "Sauce" },
        { id: "aioli", name: "Alioli", price: 0.90, group: "Sauce" },
        { id: "bbq", name: "BBQ", price: 0.90, group: "Sauce" },
        { id: "spicyMayo", name: "Mayo spicy", price: 0.95, group: "Sauce" },
        { id: "truffle", name: "Trufa", price: 2.40, group: "Luxe" },
      ],
    };

    const MAX_PROTEIN_LAYERS = 4;
    const MAX_CHEESE_LAYERS = 4;

    function wrapIndex(i, len) {
      if (len <= 0) return 0;
      return (i % len + len) % len;
    }

    function IconButton({ label, onClick, title }) {
      return (
        <button onClick={onClick} title={title} className="btn-ghost px-4 py-2" type="button">
          {label}
        </button>
      );
    }

    function CarouselPicker({ title, options, index, onPrev, onNext }) {
      const opt = options[index];
      return (
        <div className="rounded-3xl border border-divineLine2 bg-black/20 p-4">
          <div className="text-xs tracking-[0.35em] text-divineGold/90">{title.toUpperCase()}</div>
          <div className="mt-3 grid grid-cols-[auto_1fr_auto] items-center gap-3">
            <IconButton label="←" title="Anterior" onClick={onPrev} />
            <motion.div
              key={opt?.id}
              initial={{ opacity: 0, y: 8 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.18 }}
              className="rounded-2xl border border-divineLine2 bg-divinePanel p-4"
            >
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="text-base font-semibold">{opt?.name}</div>
                  <div className="mt-1 text-sm text-divineCream/65">{opt?.note}</div>
                </div>
                <div className="text-sm font-semibold text-divineGold">{money(opt?.price ?? 0)}</div>
              </div>
            </motion.div>
            <IconButton label="→" title="Siguiente" onClick={onNext} />
          </div>
        </div>
      );
    }

    function LayersHeader({ title, count, onAdd, addLabel, disabled }) {
      return (
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div className="text-xs tracking-[0.35em] text-divineGold/90">{title.toUpperCase()}</div>
            <div className="mt-1 text-sm text-divineCream/65">Capas: <span className="text-divineCream">{count}</span></div>
          </div>
          <button type="button" onClick={onAdd} className="btn-ghost px-4 py-2" disabled={disabled} style={{ opacity: disabled ? 0.55 : 1 }}>
            + <span className="ml-1">{addLabel}</span>
          </button>
        </div>
      );
    }

    function LayersTabs({ label, layers, active, setActive, onRemove, min = 1 }) {
      return (
        <div className="mt-3 flex gap-2 overflow-x-auto scroll-smooth-ios pb-1 mobile-scroll">
          {layers.map((_, i) => (
            <div key={i} className="flex items-center gap-1">
              <button
                type="button"
                onClick={() => setActive(i)}
                className={[
                  "whitespace-nowrap rounded-full border px-3 py-2 text-[11px] tracking-[0.22em] transition backdrop-blur",
                  active === i
                    ? "border-divineGold/60 bg-black/35 text-divineGold shadow-glow"
                    : "border-divineLine2 bg-black/25 text-divineCream/70 hover:text-divineGold hover:border-divineGold/40",
                ].join(" ")}
              >
                {label.toUpperCase()} {i + 1}
              </button>
              {layers.length > min && (
                <button
                  type="button"
                  onClick={() => onRemove(i)}
                  className="rounded-full border border-divineLine2 bg-black/25 px-2 py-2 text-[11px] text-divineCream/70 hover:text-divineGold hover:border-divineGold/40 transition"
                  title="Eliminar capa"
                >
                  ×
                </button>
              )}
            </div>
          ))}
        </div>
      );
    }

function BurgerBuilder({ onAddToCart }) {
      const [step, setStep] = useState(0);
      const [bunIdx, setBunIdx] = useState(0);
      const [proteinLayers, setProteinLayers] = useState([0]);
      const [activeProteinLayer, setActiveProteinLayer] = useState(0);
      const [cheeseLayers, setCheeseLayers] = useState([5]); // Índice 5 es "Sin queso"
      const [activeCheeseLayer, setActiveCheeseLayer] = useState(0);
      const [toppings, setToppings] = useState([]);

      const bun = BURGER_CATALOG.buns[bunIdx];
      const cheesesCount = Math.max(0, cheeseLayers.filter((idx) => BURGER_CATALOG.cheeses[idx]?.id !== "none").length);

      const price = useMemo(() => {
        const bunP = bun?.price ?? 0;
        const proteinsP = proteinLayers.reduce((acc, idx) => acc + (BURGER_CATALOG.proteins[idx]?.price ?? 0), 0);
        const cheesesP = cheeseLayers.reduce((acc, idx) => acc + (BURGER_CATALOG.cheeses[idx]?.price ?? 0), 0);
        const toppingsP = toppings.reduce((acc, id) => acc + (BURGER_CATALOG.toppings.find((t) => t.id === id)?.price ?? 0), 0);
        return BURGER_BASE + bunP + proteinsP + cheesesP + toppingsP;
      }, [bunIdx, proteinLayers, cheeseLayers, toppings]);

      // Generación dinámica del modelo 3D
      const dynamicConfig = useMemo(() => {
        const conf = [{ type: 'bunBottom' }];
        proteinLayers.forEach(() => conf.push({ type: 'meat' }));
        cheeseLayers.forEach((idx) => { if (BURGER_CATALOG.cheeses[idx]?.id !== 'none') conf.push({ type: 'cheese' }); });
        toppings.forEach(id => {
          if (id === 'lettuce' || id === 'arugula') conf.push({ type: 'lettuce' });
          else if (id === 'tomato') conf.push({ type: 'tomato' });
          else conf.push({ type: 'generic' });
        });
        conf.push({ type: 'bunTop' });
        return conf;
      }, [proteinLayers, cheeseLayers, toppings]);

      const valid = proteinLayers.length >= 1;
      const steps = ["PAN", "CARNES", "QUESOS", "TOPPINGS"];

      function toggleTopping(id) { setToppings((prev) => (prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id])); }
      function bunPrev() { setBunIdx((i) => wrapIndex(i - 1, BURGER_CATALOG.buns.length)); }
      function bunNext() { setBunIdx((i) => wrapIndex(i + 1, BURGER_CATALOG.buns.length)); }
      function proteinPrev() { setProteinLayers((layers) => { const copy = [...layers]; copy[activeProteinLayer] = wrapIndex(copy[activeProteinLayer] - 1, BURGER_CATALOG.proteins.length); return copy; }); }
      function proteinNext() { setProteinLayers((layers) => { const copy = [...layers]; copy[activeProteinLayer] = wrapIndex(copy[activeProteinLayer] + 1, BURGER_CATALOG.proteins.length); return copy; }); }
      function addProteinLayer() { setProteinLayers((layers) => { if (layers.length >= MAX_PROTEIN_LAYERS) return layers; return [...layers, layers[layers.length - 1] ?? 0]; }); setActiveProteinLayer((i) => Math.min(i + 1, MAX_PROTEIN_LAYERS - 1)); }
      function removeProteinLayer(i) { setProteinLayers((layers) => layers.filter((_, idx) => idx !== i)); setActiveProteinLayer((cur) => (cur > 0 ? cur - 1 : 0)); }
      function cheesePrev() { setCheeseLayers((layers) => { const copy = [...layers]; copy[activeCheeseLayer] = wrapIndex(copy[activeCheeseLayer] - 1, BURGER_CATALOG.cheeses.length); return copy; }); }
      function cheeseNext() { setCheeseLayers((layers) => { const copy = [...layers]; copy[activeCheeseLayer] = wrapIndex(copy[activeCheeseLayer] + 1, BURGER_CATALOG.cheeses.length); return copy; }); }
      function addCheeseLayer() { setCheeseLayers((layers) => { if (layers.length >= MAX_CHEESE_LAYERS) return layers; return [...layers, layers[layers.length - 1] ?? 0]; }); setActiveCheeseLayer((i) => Math.min(i + 1, MAX_CHEESE_LAYERS - 1)); }
      function removeCheeseLayer(i) { setCheeseLayers((layers) => layers.filter((_, idx) => idx !== i)); setActiveCheeseLayer((cur) => (cur > 0 ? cur - 1 : 0)); }

      function buildAndAdd() {
        if (!valid) return;
        const bunSel = BURGER_CATALOG.buns[bunIdx];
        const proteinsSel = proteinLayers.map((idx) => BURGER_CATALOG.proteins[idx]).filter(Boolean);
        const cheesesSel = cheeseLayers.map((idx) => BURGER_CATALOG.cheeses[idx]).filter(Boolean);
        const toppingsSel = toppings.map((id) => BURGER_CATALOG.toppings.find((t) => t.id === id)).filter(Boolean);
        
        const id = ["custom-burger", bunSel?.id, proteinsSel.map((p) => p.id).join("+"), cheesesSel.map((c) => c.id).join("+"), toppings.slice().sort().join(",")].join(":");
        
        const meta = {
          pan: bunSel?.name,
          carnes: proteinsSel.map((p) => p.name),
          quesos: cheesesSel.map((c) => c.name),
          toppings: toppingsSel.map((t) => t.name),
        };
        
        onAddToCart?.({ id, name: "Hamburguesa Divinée (Atelier)", price, meta });
        setStep(0); setBunIdx(0); setProteinLayers([0]); setActiveProteinLayer(0); setCheeseLayers([5]); setActiveCheeseLayer(0); setToppings([]);
      }

      return (
        <div className="rounded-3xl glass ring-gold p-4 md:p-6">
          <div className="flex flex-wrap items-start justify-between gap-3">
            <div>
              <div className="text-xs tracking-[0.35em] text-divineGold/90">ATELIER</div>
              <h3 className="mt-2 text-xl font-semibold md:text-2xl">Arma tu Hamburguesa</h3>
              <p className="mt-1 text-sm text-divineCream/65">Carrusel + capas múltiples.</p>
            </div>
            <div className="rounded-2xl border border-divineLine2 bg-black/25 px-4 py-3 shadow-glow">
              <div className="text-[10px] tracking-[0.28em] text-divineCream/55">PRECIO</div>
              <div className="mt-1 text-lg font-semibold text-divineGold">{money(price)}</div>
            </div>
          </div>
          
          <div className="mt-5 rounded-3xl border border-divineLine2 bg-black/20 overflow-hidden">
            <div className="flex items-center justify-between px-4 py-3 border-b border-divineLine2 bg-black/25">
              <div>
                <div className="text-xs tracking-[0.35em] text-divineGold/90">VISTA 3D</div>
                <div className="text-xs text-divineCream/60">Arrastra para rotar 360°</div>
              </div>
              <div className="text-xs tracking-[0.22em] text-divineCream/55">
                {proteinLayers.length} carne(s) • {cheesesCount} queso(s)
              </div>
            </div>
            <BurgerViewer3D heightClass="h-[240px] md:h-[320px]" modelUrl={null} burgerConfig={dynamicConfig} showUI={false} />
          </div>

          <div className="mt-5 grid grid-cols-4 gap-2">
            {steps.map((label, i) => (
              <button key={label} onClick={() => setStep(i)} className={["rounded-2xl border px-3 py-2 text-[11px] tracking-[0.22em] transition", step === i ? "border-divineGold/60 bg-black/35 text-divineGold shadow-glow" : "border-divineLine bg-black/25 text-divineCream/70 hover:text-divineGold hover:border-divineGold/40"].join(" ")} type="button">
                {label}
              </button>
            ))}
          </div>

          <motion.div key={step} initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.25 }} className="mt-5">
            {step === 0 && (
              <CarouselPicker title="Pan" options={BURGER_CATALOG.buns} index={bunIdx} onPrev={bunPrev} onNext={bunNext} />
            )}
            {step === 1 && (
              <div className="space-y-4">
                <LayersHeader title="Carnes" count={proteinLayers.length} onAdd={addProteinLayer} addLabel="Agregar otra carne" disabled={proteinLayers.length >= MAX_PROTEIN_LAYERS} />
                <LayersTabs label="Carne" layers={proteinLayers} active={activeProteinLayer} setActive={setActiveProteinLayer} onRemove={removeProteinLayer} min={1} />
                <CarouselPicker title={`Carne ${activeProteinLayer + 1}`} options={BURGER_CATALOG.proteins} index={proteinLayers[activeProteinLayer] ?? 0} onPrev={proteinPrev} onNext={proteinNext} />
              </div>
            )}
            {step === 2 && (
              <div className="space-y-4">
                <LayersHeader title="Quesos" count={cheeseLayers.length} onAdd={addCheeseLayer} addLabel="Agregar otro queso" disabled={cheeseLayers.length >= MAX_CHEESE_LAYERS} />
                <LayersTabs label="Queso" layers={cheeseLayers} active={activeCheeseLayer} setActive={setActiveCheeseLayer} onRemove={removeCheeseLayer} min={1} />
                <CarouselPicker title={`Queso ${activeCheeseLayer + 1}`} options={BURGER_CATALOG.cheeses} index={cheeseLayers[activeCheeseLayer] ?? 0} onPrev={cheesePrev} onNext={cheeseNext} />
              </div>
            )}
            {step === 3 && (
              <div className="rounded-3xl border border-divineLine2 bg-black/20 p-4">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="text-xs tracking-[0.35em] text-divineGold/90">TOPPINGS</div>
                    <div className="mt-1 text-sm text-divineCream/65">Selecciona todos los que quieras.</div>
                  </div>
                  <div className="text-xs tracking-[0.22em] text-divineCream/55">{toppings.length} seleccionados</div>
                </div>
                <div className="mt-4 grid gap-2 sm:grid-cols-2">
                  {BURGER_CATALOG.toppings.map((t) => {
                    const active = toppings.includes(t.id);
                    return (
                      <button key={t.id} onClick={() => toggleTopping(t.id)} className={["rounded-2xl border px-4 py-3 text-left transition", active ? "border-divineGold/60 bg-black/35 shadow-glow" : "border-divineLine bg-black/25 hover:border-divineGold/40"].join(" ")} type="button">
                        <div className="flex items-start justify-between gap-3">
                          <div>
                            <div className="font-semibold">{t.name}</div>
                            <div className="mt-1 text-xs tracking-[0.18em] text-divineCream/55">{t.group.toUpperCase()}</div>
                          </div>
                          <div className="text-sm font-semibold text-divineGold">{money(t.price)}</div>
                        </div>
                      </button>
                    );
                  })}
                </div>
              </div>
            )}
          </motion.div>

          {/* --- AQUÍ ESTÁ EL NUEVO DESGLOSE/TICKET --- */}
          <div className="mt-8 rounded-2xl border border-divineLine2 bg-divinePanel p-4">
            <div className="text-[10px] tracking-[0.28em] text-divineCream/60 mb-3">DESGLOSE DEL PEDIDO</div>
            <div className="space-y-2 text-sm text-divineCream/75">
              <div className="flex justify-between"><span>Base Divinée</span><span>{money(BURGER_BASE)}</span></div>
              <div className="flex justify-between"><span>{bun?.name}</span><span>{money(bun?.price ?? 0)}</span></div>
              
              {proteinLayers.map((idx, i) => {
                const p = BURGER_CATALOG.proteins[idx];
                if (!p) return null;
                return <div key={`p-${i}`} className="flex justify-between"><span>{p.name}</span><span>{money(p.price)}</span></div>;
              })}
              
              {cheeseLayers.map((idx, i) => {
                const c = BURGER_CATALOG.cheeses[idx];
                if (!c || c.id === 'none') return null;
                return <div key={`c-${i}`} className="flex justify-between"><span>{c.name}</span><span>{money(c.price)}</span></div>;
              })}
              
              {toppings.map((id) => {
                const t = BURGER_CATALOG.toppings.find((x) => x.id === id);
                if (!t) return null;
                return <div key={id} className="flex justify-between"><span>{t.name}</span><span>{money(t.price)}</span></div>;
              })}
            </div>
            <div className="mt-3 pt-3 border-t border-divineLine flex justify-between font-semibold">
              <span className="text-divineCream">TOTAL</span>
              <span className="text-divineGold">{money(price)}</span>
            </div>
          </div>
          {/* --- FIN DEL DESGLOSE --- */}

          <div className="mt-6 flex flex-wrap items-center gap-3">
            <button onClick={() => setStep((s) => Math.max(0, s - 1))} className="btn-ghost" type="button">ATRÁS</button>
            <button onClick={() => setStep((s) => Math.min(3, s + 1))} className="btn-ghost" type="button">SIGUIENTE</button>
            <button onClick={buildAndAdd} className="ml-auto btn-primary" disabled={!valid} style={{ opacity: valid ? 1 : 0.6 }} type="button">
              ARMAR
            </button>
          </div>
        </div>
      );
    }

    function YogurtComingSoonCard() {
      return (<div className="rounded-3xl border border-divineLine2 bg-black/25 p-6 shadow-divine"><div className="text-[10px] tracking-[0.35em] text-divineGold/90">GREEK YOGURT</div><div className="mt-2 text-3xl font-semibold">¡MUY PRONTO!</div><p className="mt-3 text-sm text-divineCream/70">Estamos preparando esta experiencia para ti.</p><div className="mt-5 inline-flex items-center gap-2 rounded-full border border-divineLine2 bg-black/20 px-4 py-2 text-xs tracking-[0.22em] text-divineCream/65">YOGURT DE MÁQUINA • NO DISPONIBLE</div></div>);
    }

    // =========================
    // App Base
    // =========================
    function App() {
      useSpotlight();
      const refs = { burgers: useRef(null), desserts: useRef(null), yogurt: useRef(null), atelier: useRef(null) };
      const [activeBurger, setActiveBurger] = useState(null);
      const [cartOpen, setCartOpen] = useState(false);
      const [cartItems, setCartItems] = useState([]);
      const cartCount = useMemo(() => cartItems.reduce((acc, it) => acc + it.qty, 0), [cartItems]);
      const cartTotal = useMemo(() => cartItems.reduce((acc, it) => acc + it.price * it.qty, 0), [cartItems]);

      function scrollTo(key) { refs[key]?.current?.scrollIntoView({ behavior: "smooth", block: "start" }); }
      function addToCart(item) {
        setCartItems((prev) => {
          const idx = prev.findIndex((p) => p.id === item.id);
          if (idx >= 0) { const copy = [...prev]; copy[idx] = { ...copy[idx], qty: copy[idx].qty + 1 }; return copy; }
          return [...prev, { ...item, qty: 1 }];
        });
      }
      function updateQty(id, qty) { setCartItems((prev) => prev.map((p) => (p.id === id ? { ...p, qty } : p)).filter((p) => p.qty > 0)); }

      return (
        <div className="min-h-screen relative z-[1]">
          <Header onNavigate={scrollTo} onOpenCart={() => setCartOpen(true)} cartCount={cartCount} />
          <main className="mx-auto max-w-6xl px-4 pb-28 pt-28 md:pt-28 md:px-6">
            <motion.section initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.6, ease: [0.2, 0.8, 0.2, 1] }} className="mb-8 md:mb-14">
              <div className="rounded-3xl hero-grid shadow-divine p-5 md:p-10"><p className="mb-3 text-xs tracking-[0.35em] text-divineGold/90">{BRAND_NAME.toUpperCase()} • GOURMET BAR</p><h1 className="text-3xl font-semibold leading-tight md:text-6xl"><span className="bg-gradient-to-r from-divineCream via-divineCream to-divineGold bg-clip-text text-transparent">Hamburguesas, postres y yogurt griego</span> con estética de lujo.</h1><p className="mt-3 max-w-2xl text-sm text-divineCream/75 md:text-base">Explora el menú y arma tu burger con un configurador premium.</p><div className="mt-5 flex flex-col sm:flex-row flex-wrap gap-3"><button className="btn-primary w-full sm:w-auto" onClick={() => scrollTo("burgers")} type="button">Explorar menú</button><button className="btn-ghost w-full sm:w-auto" onClick={() => scrollTo("atelier")} type="button">Atelier</button></div></div>
            </motion.section>
            <section ref={refs.burgers} className="scroll-mt-32"><SectionShell eyebrow="COLECCIÓN DIVINÉE" title="Hamburguesas" subtitle="Cae el modelo al seleccionarlas."><ProductShowcase items={burgers} badge="VER 360°" onOpen={setActiveBurger} onAdd={addToCart} /></SectionShell></section>
            <section ref={refs.desserts} className="scroll-mt-32"><SectionShell eyebrow="EXQUISITE DESSERTS" title="Postres" subtitle="Selección corta, elegante."><ProductShowcase items={desserts} badge="PATISSERIE" onOpen={(p) => addToCart({ ...p, qty: 1 })} onAdd={addToCart} /></SectionShell></section>
            <section ref={refs.yogurt} className="scroll-mt-32"><SectionShell eyebrow="GREEK YOGURT DE MÁQUINA" title="Yogurt" subtitle="Sección desactivada temporalmente."><YogurtComingSoonCard /></SectionShell></section>
            <section ref={refs.atelier} className="scroll-mt-32"><SectionShell eyebrow="ATELIER" title="Arma tu Hamburguesa" subtitle="Configurador en vivo, agrega ingredientes y verás cómo caen."><BurgerBuilder onAddToCart={addToCart} /></SectionShell></section>
          </main>
          <CartButton cartCount={cartCount} onClick={() => setCartOpen(true)} />
          <AnimatePresence>{cartOpen && <CartDrawer items={cartItems} total={cartTotal} onClose={() => setCartOpen(false)} onQty={updateQty} />}</AnimatePresence>
          <AnimatePresence>{!!activeBurger && <ProductModal product={activeBurger} onClose={() => setActiveBurger(null)} onAdd={() => addToCart({ id: activeBurger.id, name: activeBurger.name, price: activeBurger.price })} />}</AnimatePresence>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById("root")); root.render(<App />);
  </script>
</body>
</html>



