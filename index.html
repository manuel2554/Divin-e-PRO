<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="theme-color" content="#07070A" />
  <title>Divinée — Gourmet Bar</title>
  <meta property="og:title" content="Divinée Gourmet Bar | La mejor experiencia" />
  <meta property="og:description" content="Hamburguesas, postres y yogurt griego con estética de lujo. Pide ahora y vive la experiencia Divinée en Pueblo Llano." />
  <meta property="og:image" content="https://i.imgur.com/uR1d5k7.png" />
  <meta property="og:type" content="website" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            divineBg: "#07070A", divineInk: "#0A0A0F", divineCream: "#F5EFE6",
            divineGold: "#C7A35C", divineGold2: "#E6D3A3",
            divinePanel: "rgba(255,255,255,0.06)", divineLine: "rgba(255,255,255,0.10)",
            divineLine2: "rgba(199,163,92,0.22)",
          },
          boxShadow: {
            divine: "0 30px 80px rgba(0,0,0,0.60)",
            glow: "0 0 0 1px rgba(199,163,92,0.18), 0 18px 60px rgba(199,163,92,0.12)",
          },
          letterSpacing: { luxe: "0.18em" },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cpath fill='%23C7A35C' d='M32 6l7 14 15 2-11 11 3 15-14-7-14 7 3-15-11-11 15-2z'/%3E%3C/svg%3E"/>
  
  <style>
    :root { color-scheme: dark; --mx: 50vw; --my: 20vh; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #07070a; color: #f5efe6; overflow-x: hidden;
    }
    ::selection { background: rgba(199,163,92,0.35); }
    .divine-noise{ position:fixed; inset:0; pointer-events:none; opacity:.05; z-index:0; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E"); }
    .divine-spotlight{ position:fixed; inset:0; pointer-events:none; z-index:0; background: radial-gradient(700px 520px at var(--mx) var(--my), rgba(199,163,92,0.22), transparent 55%), radial-gradient(1000px 700px at 20% 35%, rgba(255,255,255,0.06), transparent 60%), radial-gradient(1200px 600px at 80% 5%, rgba(199,163,92,0.14), transparent 62%); filter:saturate(1.05); transition: background 120ms linear; }
    .line-clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .glass{ background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); backdrop-filter: blur(18px); -webkit-backdrop-filter: blur(18px); }
    .ring-gold{ box-shadow: 0 0 0 1px rgba(199,163,92,0.18), 0 24px 70px rgba(0,0,0,0.55); }
    .btn-primary{ position:relative; overflow:hidden; border-radius:16px; border:1px solid rgba(199,163,92,0.55); background: linear-gradient(135deg, rgba(199,163,92,1), rgba(230,211,163,1)); color:#07070a; font-weight:700; letter-spacing:0.18em; text-transform:uppercase; font-size:12px; padding:12px 16px; transition: transform 160ms ease, filter 160ms ease; }
    .btn-primary::after{ content:""; position:absolute; inset:-2px; background: linear-gradient(120deg, transparent 40%, rgba(255,255,255,0.55), transparent 60%); transform: translateX(-120%); transition: transform 550ms ease; opacity:.7; }
    .btn-primary:hover{ filter: brightness(1.05); transform: translateY(-1px); }
    .btn-primary:hover::after{ transform: translateX(120%); }
    .btn-ghost{ border-radius:16px; border:1px solid rgba(255,255,255,0.14); background: rgba(0,0,0,0.25); color: rgba(245,239,230,0.85); letter-spacing:0.18em; text-transform:uppercase; font-size:12px; padding:12px 16px; transition: border-color 160ms ease, color 160ms ease, transform 160ms ease; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .btn-ghost:hover{ border-color: rgba(199,163,92,0.55); color: rgba(199,163,92,0.95); transform: translateY(-1px); }
    .btn-disabled{ opacity:.45; filter:saturate(.6); cursor:not-allowed; }
    .nav-link{ position:relative; padding:8px 6px; }
    .nav-link::after{ content:""; position:absolute; left:6px; right:6px; bottom:2px; height:1px; background: linear-gradient(90deg, transparent, rgba(199,163,92,0.9), transparent); transform: scaleX(0); transform-origin:center; transition: transform 220ms ease; opacity:.9; }
    .nav-link:hover::after{ transform: scaleX(1); }
    .card-premium{ position:relative; overflow:hidden; }
    .card-premium::before{ content:""; position:absolute; inset:-1px; background: radial-gradient(600px 220px at 20% 0%, rgba(199,163,92,0.18), transparent 60%); opacity:0; transition: opacity 350ms ease; pointer-events:none; }
    .card-premium:hover::before{ opacity:1; }
    .card-premium::after{ content:""; position:absolute; inset:0; background: linear-gradient(to top, rgba(0,0,0,0.58), transparent 45%); opacity:0.55; pointer-events:none; }
    .hero-grid{ background: radial-gradient(1000px 500px at 10% 10%, rgba(199,163,92,0.10), transparent 60%), radial-gradient(900px 500px at 90% 20%, rgba(255,255,255,0.06), transparent 60%), linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,0.25)); border: 1px solid rgba(255,255,255,0.08); }
    .scroll-smooth-ios{ -webkit-overflow-scrolling: touch; }
    .floating-safe{ bottom: calc(1.1rem + env(safe-area-inset-bottom)); right: calc(1.1rem + env(safe-area-inset-right)); }
    .mobile-scroll{ overflow-x:auto; -webkit-overflow-scrolling: touch; scrollbar-width:none; }
    .mobile-scroll::-webkit-scrollbar{ display:none; }
    .sheet-handle{ width:56px; height:5px; border-radius:999px; background: rgba(245,239,230,0.22); border: 1px solid rgba(199,163,92,0.22); }
    @media (prefers-reduced-motion: reduce){ .btn-primary, .btn-ghost, .nav-link::after { transition:none !important; } }
  </style>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/framer-motion@11/dist/framer-motion.umd.js"></script>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="divine-spotlight"></div>
  <div class="divine-noise"></div>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const React = window.React;
    const { useEffect, useMemo, useRef, useState } = React;

    // =========================
    // Flags / Branding
    // =========================
    const BRAND_NAME = "Divinée";
    const LOGO_LOCAL = "./assets/logo-divinee.jpg";
    const LOGO_REMOTE = "https://i.postimg.cc/J7czGY3s/Whats_App_Image_2026_02_10_at_2_42_10_PM.jpg";
    const YOGURT_ENABLED = false;
    
    // =========================
    // Configuración de Supabase y Telegram
    // =========================
    // 1. SUPABASE (Las llaves que copiaste de la foto)
    const { createClient } = window.supabase;
    const supabaseUrl = "https://djkmmzbxicsbexeutuzz.supabase.co"; // Ej: https://k0kc9dsil...supabase.co
    const supabaseKey = "sb_publishable_kOKC9dSiLSqhOQvxjx24yQ_aFP2VYuM"
;     // Ej: sb_publishable_k0kc...
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    // 2. TELEGRAM (Lo que acabas de sacar de BotFather)
    const TELEGRAM_BOT_TOKEN = "8566482559:AAEKenkBkriNlZAjlyIGBWWzGDTB3sFzyCA";    // Ej: 712345678:AAGdf...
    const TELEGRAM_CHAT_ID = "1145054461";            // Ej: 123456789

    // 3. UTILIDAD PARA BOLÍVARES
    const moneyVES = (usd, rate) => new Intl.NumberFormat("es-VE", { style: "currency", currency: "VES" }).format(usd * rate);

// =========================
    // Motion fallback (Corregido para no perder el cursor)
    // =========================
    const FM = window.Motion || window.framerMotion || {};
    function stripMotionProps(props = {}) {
      const clean = { ...props };
      ["initial","animate","exit","transition","whileHover","whileInView","viewport","layout","variants","drag","dragConstraints","dragElastic","onDragEnd"].forEach((k) => delete clean[k]);
      return clean;
    }
    function createMotionFallback() {
      const cache = {};
      return new Proxy({}, {
        get: (_, tag) => {
          if (!cache[tag]) {
            cache[tag] = React.forwardRef((props, ref) => {
              const { children, ...rest } = props || {};
              return React.createElement(tag, { ...stripMotionProps(rest), ref }, children);
            });
          }
          return cache[tag];
        }
      });
    }
    const motion = FM.motion || createMotionFallback();
    const AnimatePresence = FM.AnimatePresence || (({ children }) => React.createElement(React.Fragment, null, children));

    // =========================
    // Utils + Hooks
    // =========================
    const money = (n) => new Intl.NumberFormat("en-US", { style: "currency", currency: "USD" }).format(n);
    function useLockBodyScroll(locked) {
      useEffect(() => {
        if (!locked) return;
        const prev = document.body.style.overflow;
        document.body.style.overflow = "hidden";
        return () => { document.body.style.overflow = prev; };
      }, [locked]);
    }
    function useEscape(handler, active = true) {
      useEffect(() => {
        if (!active) return;
        const onKeyDown = (e) => e.key === "Escape" && handler?.();
        window.addEventListener("keydown", onKeyDown);
        return () => window.removeEventListener("keydown", onKeyDown);
      }, [handler, active]);
    }
    function useSpotlight() {
      useEffect(() => {
        const root = document.documentElement;
        let raf = null;
        let tx = window.innerWidth * 0.55, ty = window.innerHeight * 0.18;
        let cx = tx, cy = ty;
        const tick = () => {
          cx += (tx - cx) * 0.12; cy += (ty - cy) * 0.12;
          root.style.setProperty("--mx", `${cx}px`); root.style.setProperty("--my", `${cy}px`);
          raf = requestAnimationFrame(tick);
        };
        const onMove = (e) => { tx = e.clientX; ty = e.clientY; };
        const onTouch = () => { tx = window.innerWidth * 0.55; ty = window.innerHeight * 0.25; };
        window.addEventListener("pointermove", onMove, { passive: true });
        window.addEventListener("touchstart", onTouch, { passive: true });
        raf = requestAnimationFrame(tick);
        return () => {
          window.removeEventListener("pointermove", onMove);
          window.removeEventListener("touchstart", onTouch);
          cancelAnimationFrame(raf);
        };
      }, []);
    }
    function useIsMobile() {
      const [isMobile, setIsMobile] = useState(() => window.innerWidth < 640);
      useEffect(() => {
        const onResize = () => setIsMobile(window.innerWidth < 640);
        window.addEventListener("resize", onResize);
        return () => window.removeEventListener("resize", onResize);
      }, []);
      return isMobile;
    }
    function useHistoryClose(active, onClose) {
      const pushedRef = useRef(false);
      useEffect(() => {
        if (!active) return;
        pushedRef.current = true;
        history.pushState({ __divineeOverlay: true }, "");
        const onPop = () => { pushedRef.current = false; onClose?.(); };
        window.addEventListener("popstate", onPop);
        return () => window.removeEventListener("popstate", onPop);
      }, [active, onClose]);
      return () => { if (pushedRef.current) { history.back(); return; } onClose?.(); };
    }

    // =========================
    // Data
    // =========================
      const burgers = [
      { 
        id: "clasica-divinee", 
        name: "Clásica Divinée", 
        description: "La tradición elevada. Jugosa carne Smash en pan brioche sellado, jamón cheddar, huevo y tocino crujiente con el toque fresco de la casa.", 
        price: 8.80, 
        grams: 120, 
        img: "https://i.postimg.cc/bwqjqMf9/Gemini_Generated_Image_cj43xcj43xcj43xc.png", 
        ingredients: ["Pan Brioche", "Carne Smash 120g", "Queso", "Jamón Cheddar", "Huevo", "Tocino", "Papas Hilo", "Lechuga y Tomate"], 
        nutrition: { kcal: 650, proteina_g: 32, carbos_g: 40, grasa_g: 38 }, 
        config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"generic"},{type:"lettuce"},{type:"bunTop"}] 
      },
      { 
        id: "pollo-divino", 
        name: "Pollo Divino", 
        description: "Tierna y ligera. Filete de pollo seleccionado a la plancha sobre pan brioche, con el equilibrio perfecto de queso, jamón y huevo.", 
        price: 8.50, 
        grams: 120, 
        img: "https://i.postimg.cc/t49H9fH0/Gemini_Generated_Image_r93243r93243r932.png", 
        ingredients: ["Pan Brioche", "Filete de Pollo 120g", "Queso", "Jamón", "Huevo", "Tocino", "Papas Hilo","Lechuga y Tomate"], 
        nutrition: { kcal: 580, proteina_g: 38, carbos_g: 35, grasa_g: 28 }, 
        config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"generic"},{type:"bunTop"}] 
      },
      { 
        id: "porc-divinee", 
        name: "Porc Divinée", 
        description: "Sabor ahumado y premium. Lomo de cerdo de alta selección con queso fundido y tocino en pan brioche artesanal.", 
        price: 9.50, 
        grams: 150, 
        img: "https://i.postimg.cc/fRMhMFQK/Gemini_Generated_Image_d5qhrid5qhrid5qh.png", 
        ingredients: ["Pan Brioche", "Lomo de Cerdo", "Queso", "Jamón", "Huevo", "Tocino", "Papas Hilo","Lechuga y Tomate"], 
        nutrition: { kcal: 710, proteina_g: 35, carbos_g: 38, grasa_g: 42 }, 
        config: [{type:"bunBottom"},{type:"meat"},{type:"cheese"},{type:"generic"},{type:"bunTop"}] 
      },
      { 
        id: "divinee-mixta", 
        name: "Divinée Mixta", 
        description: "La dualidad perfecta. Fusión imponente de lomo de cerdo y lomito de res, diseñada para los que buscan potencia y sabor extremo.", 
        price: 12.99, 
        grams: 300, 
        img: "https://i.postimg.cc/8zTVT3gb/Gemini_Generated_Image_51ak0f51ak0f51ak.png", 
        ingredients: ["Pan Brioche", "Lomito de Res", "Lomo de Cerdo", "Queso", "Jamón", "Huevo", "Tocino", "Papas Hilo", "Lechuga y Tomate"], 
        nutrition: { kcal: 890, proteina_g: 52, carbos_g: 42, grasa_g: 55 }, 
        config: [{type:"bunBottom"},{type:"meat"},{type:"meat"},{type:"cheese"},{type:"lettuce"},{type:"bunTop"}] 
      },
      { 
        id: "divinee-absoluta", 
        name: "Divinée Absoluta", 
        description: "La joya de la corona. Cuatro proteínas (Smash, Lomo, Pollo y Chorizo) unidas en una creación monumental sin límites.", 
        price: 16.99, 
        grams: 600, 
        img: "https://i.postimg.cc/Z5JhJgzF/Gemini_Generated_Image_kjudi7kjudi7kjud.png", 
        ingredients: ["Pan Brioche", "Carne Smash", "Lomo de Cerdo", "Pollo", "Chorizo Premium", "Queso", "Jamón", "Huevo", "Tocino", "Papas Hilo", "Lechuga y Tomate"], 
        nutrition: { kcal: 1250, proteina_g: 85, carbos_g: 45, grasa_g: 78 }, 
        config: [{type:"bunBottom"},{type:"meat"},{type:"meat"},{type:"meat"},{type:"meat"},{type:"cheese"},{type:"lettuce"},{type:"bunTop"}] 
      },
    ];
    const desserts = [
      { id: "noir-cheesecake", name: "Noir Cheesecake", description: "Cheesecake sedoso con cacao oscuro y crumble de avellana.", price: 9.5, img: "https://images.unsplash.com/photo-1541781408260-3c7b8d7a5b61?auto=format&fit=crop&w=1600&q=80" },
      { id: "gold-mousse", name: "Gold Mousse", description: "Mousse de vainilla de Madagascar con brillo dorado sutil.", price: 10.25, img: "https://images.unsplash.com/photo-1601972602237-8c79241e468b?auto=format&fit=crop&w=1600&q=80" },
      { id: "creme-brulee-tart", name: "Tarta Crème Brûlée", description: "Caramelo flameado, núcleo de crema y base mantequilla.", price: 10.75, img: "https://images.unsplash.com/photo-1608198093002-ad4e005484ec?auto=format&fit=crop&w=1600&q=80" },
      { id: "pistachio-opera", name: "Ópera de Pistacho", description: "Capas de pistacho con notas de espresso y glaseado satinado.", price: 11.5, img: "https://images.unsplash.com/photo-1589308078059-be1415eab4c3?auto=format&fit=crop&w=1600&q=80" },
    ];

    // =========================
    // Three helpers
    // =========================
    function makeNoiseTexture(THREE, { size = 256, contrast = 0.6 } = {}) {
      const c = document.createElement("canvas"); c.width = c.height = size;
      const ctx = c.getContext("2d", { willReadFrequently: true });
      const img = ctx.createImageData(size, size);
      for (let i = 0; i < img.data.length; i += 4) {
        const v = Math.floor(120 + (Math.random() - 0.5) * 255 * contrast);
        img.data[i] = v; img.data[i + 1] = v; img.data[i + 2] = v; img.data[i + 3] = 255;
      }
      ctx.putImageData(img, 0, 0);
      const tex = new THREE.CanvasTexture(c);
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping; tex.repeat.set(3, 3); tex.needsUpdate = true;
      return tex;
    }
    function fitCameraToObject(THREE, camera, object, offset = 1.4) {
      const box = new THREE.Box3().setFromObject(object);
      if (box.isEmpty()) return;
      const size = new THREE.Vector3(); const center = new THREE.Vector3();
      box.getSize(size); box.getCenter(center);
      const maxDim = Math.max(size.x, size.y, size.z);
      const fov = camera.fov * (Math.PI / 180);
      const cameraZ = Math.abs((maxDim / 2) / Math.tan(fov / 2)) * offset;
      camera.position.set(center.x, center.y + maxDim * 0.20, center.z + cameraZ);
      camera.lookAt(center); camera.updateProjectionMatrix();
    }
    // =========================
    // Components
    // =========================
function Header({ onNavigate, onOpenCart, cartCount, onOpenAdmin }) {
      return (
        <header className="fixed top-0 left-0 right-0 z-50 bg-black/60 backdrop-blur-xl border-b border-divineLine2/40 transition-all duration-300">
          <div className="mx-auto max-w-6xl px-4 md:px-6 pt-[env(safe-area-inset-top)]">
            
            {/* FILA SUPERIOR: Logo y Carrito */}
            <div className="flex items-center justify-between h-[64px] md:h-20">
              
              <div className="flex items-center gap-3">
                <button onClick={onOpenAdmin} className="relative group flex items-center justify-center shrink-0" title="Panel de Control">
                   <div className="absolute inset-0 bg-divineGold rounded-full blur-md opacity-20 group-hover:opacity-50 transition duration-500"></div>
                   <img src={LOGO_LOCAL} onError={(e) => e.target.src=LOGO_REMOTE} className="w-10 h-10 md:w-12 md:h-12 object-contain rounded-full border border-divineLine2/80 relative z-10 bg-white shadow-glow" alt="Divinée" />
                </button>
                <div className="hidden md:block">
                  <div className="text-xs tracking-[0.2em] text-divineGold/95">{BRAND_NAME.toUpperCase()}</div>
                  <div className="text-[10px] tracking-[0.35em] text-divineCream/60">GOURMET BAR</div>
                </div>
              </div>

              {/* Navegación Desktop */}
              <nav className="hidden md:flex flex-1 justify-center items-center gap-2">
                 <button onClick={() => onNavigate('burgers')} className="text-[11px] font-semibold tracking-[0.2em] px-4 py-2 rounded-full text-divineCream/60 hover:text-divineGold hover:bg-divineLine2/20 transition">
                   HAMBURGUESAS
                 </button>
                 <button onClick={() => onNavigate('desserts')} className="text-[11px] font-semibold tracking-[0.2em] px-4 py-2 rounded-full text-divineCream/60 hover:text-divineGold hover:bg-divineLine2/20 transition">
                   POSTRES
                 </button>
                 <button onClick={() => onNavigate('atelier')} className="text-[11px] font-semibold tracking-[0.2em] px-5 py-2 rounded-full border border-divineGold/40 text-divineGold bg-divineGold/10 hover:bg-divineGold/20 transition shadow-[0_0_15px_rgba(212,175,55,0.15)] flex items-center gap-2">
                   ✨ ATELIER
                 </button>
                 <button onClick={onOpenAdmin} className="text-[11px] font-semibold tracking-[0.2em] px-4 py-2 rounded-full text-divineCream/40 hover:text-white hover:bg-divineLine2/20 transition">
                   PANEL
                 </button>
              </nav>

              <button onClick={onOpenCart} className="shrink-0 relative flex items-center gap-2 px-4 py-2 md:py-2.5 rounded-full bg-gradient-to-r from-divineGold/20 to-divineGold/5 border border-divineGold/40 text-divineGold hover:from-divineGold/30 hover:to-divineGold/10 transition shadow-[0_0_15px_rgba(212,175,55,0.2)]">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 md:h-5 md:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                <span className="text-[10px] md:text-xs font-bold tracking-widest hidden sm:inline">CARRITO</span>
                {cartCount > 0 && (
                  <span className="absolute -top-1.5 -right-1.5 bg-divineGold text-black text-[11px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-lg border border-black">{cartCount}</span>
                )}
              </button>
            </div>

            {/* FILA INFERIOR: Navegación Mobile (Se oculta en PC) */}
            <div className="md:hidden pb-3">
              <nav className="flex overflow-x-auto no-scrollbar gap-2" style={{ WebkitOverflowScrolling: 'touch' }}>
                 <button onClick={() => onNavigate('burgers')} className="shrink-0 text-[10px] font-semibold tracking-[0.2em] px-4 py-2 rounded-full border border-divineLine2 bg-black/40 text-divineCream/75 hover:text-divineGold">
                   HAMBURGUESAS
                 </button>
                 <button onClick={() => onNavigate('desserts')} className="shrink-0 text-[10px] font-semibold tracking-[0.2em] px-4 py-2 rounded-full border border-divineLine2 bg-black/40 text-divineCream/75 hover:text-divineGold">
                   POSTRES
                 </button>
                 <button onClick={() => onNavigate('atelier')} className="shrink-0 text-[10px] font-semibold tracking-[0.2em] px-4 py-2 rounded-full border border-divineGold/50 bg-divineGold/10 text-divineGold">
                   ✨ ATELIER
                 </button>
                 <button onClick={onOpenAdmin} className="shrink-0 text-[10px] font-semibold tracking-[0.2em] px-4 py-2 rounded-full border border-divineLine2 bg-black/40 text-divineCream/40 hover:text-white">
                   PANEL
                 </button>
              </nav>
            </div>

          </div>
        </header>
      );
    }
    function SectionShell({ eyebrow, title, subtitle, children }) {
      return (
        <div className="mb-10 md:mb-16">
          <motion.div initial={{ opacity: 0, y: 14 }} whileInView={{ opacity: 1, y: 0 }} viewport={{ amount: 0.25, once: true }} transition={{ duration: 0.6, ease: [0.2, 0.8, 0.2, 1] }} className="mb-4 md:mb-7">
            <div className="mb-2 text-xs tracking-[0.35em] text-divineGold/90">{eyebrow}</div>
            <h2 className="text-2xl font-semibold md:text-4xl">{title}</h2>
            <p className="mt-2 max-w-2xl text-sm text-divineCream/70 md:text-base">{subtitle}</p>
          </motion.div>
          {children}
        </div>
      );
    }
function ProductCard({ product, badge, onClick, onAdd, isDisabled }) {
      return (
        <motion.div whileHover={!isDisabled ? { y: -6 } : {}} transition={{ type: "spring", stiffness: 260, damping: 22 }} className={`group overflow-hidden rounded-2xl border ${isDisabled ? 'border-red-500/30 bg-black/40' : 'border-divineLine bg-divinePanel'} shadow-divine relative`}>
          <div onClick={isDisabled ? undefined : onClick} className={`block w-full text-left ${isDisabled ? 'cursor-not-allowed opacity-75' : 'cursor-pointer'}`}>
            <div className="relative aspect-[4/3] overflow-hidden card-premium">
              <img src={product.img} alt={product.name} className={`h-full w-full object-cover transition duration-700 ${isDisabled ? 'grayscale' : 'group-hover:scale-[1.08]'}`} loading="lazy" />
              <div className="absolute left-3 top-3 rounded-full border border-divineLine2 bg-black/35 px-3 py-1 text-[10px] tracking-[0.28em] text-divineCream/85 backdrop-blur">{badge}</div>
              <div className="absolute right-3 top-3 rounded-full border border-divineLine2 bg-black/35 px-3 py-1 text-[10px] tracking-[0.12em] text-divineGold/95 backdrop-blur">{money(product.price)}</div>
              
              {isDisabled && (
                <div className="absolute inset-0 bg-black/40 backdrop-blur-[2px] flex items-center justify-center z-10">
                  <span className="text-red-400 font-bold tracking-widest border-2 border-red-500/50 bg-black/90 px-5 py-2 rounded-xl transform -rotate-12 shadow-[0_0_15px_rgba(239,68,68,0.3)]">AGOTADO</span>
                </div>
              )}
            </div>
            <div className="p-4 relative z-0">
              <div className="text-base font-semibold">{product.name}</div>
              <div className="mt-1 text-sm text-divineCream/70 line-clamp-2">{product.description}</div>
              <div className="mt-4 flex items-center justify-between gap-3">
                <span className="text-xs tracking-[0.22em] text-divineCream/55">{BRAND_NAME.toUpperCase()}</span>
                <button disabled={isDisabled} onClick={(e) => { e.stopPropagation(); onAdd?.(); }} className={`rounded-xl border px-3 py-2 text-xs tracking-[0.22em] transition ${isDisabled ? 'bg-red-500/10 border-red-500/30 text-red-400' : 'border-divineLine2 bg-black/25 text-divineCream/80 hover:bg-black/35 hover:text-divineGold hover:border-divineGold/50'}`} type="button">
                  {isDisabled ? 'AGOTADO' : 'AÑADIR'}
                </button>
              </div>
            </div>
          </div>
        </motion.div>
      );
    }

    function ProductShowcase({ items, badge, onOpen, onAdd, disabledItems = [] }) {
      return (
        <>
          <div className="sm:hidden">
            <div className="mobile-scroll flex gap-3 pb-2 snap-x snap-mandatory">
              {items.map((p) => {
                const isOff = disabledItems.includes(p.id);
                return (
                <div key={p.id} className="w-[78vw] max-w-[360px] snap-start">
                  <ProductCard product={p} badge={badge} isDisabled={isOff} onClick={() => onOpen(p)} onAdd={() => onAdd({ id: p.id, name: p.name, price: p.price })} />
                </div>
              )})}
            </div>
            <p className="mt-2 text-xs text-divineCream/50">Desliza horizontal para ver más.</p>
          </div>
          <div className="hidden sm:grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {items.map((p) => {
              const isOff = disabledItems.includes(p.id);
              return (
              <ProductCard key={p.id} product={p} badge={badge} isDisabled={isOff} onClick={() => onOpen(p)} onAdd={() => onAdd({ id: p.id, name: p.name, price: p.price })} />
            )})}
          </div>
        </>
      );
    }
    // =========================
    // 3D Viewer Mejorado (Cae con Físicas y Dinámico)
    // =========================
    function BurgerViewer3D({ heightClass = "h-[280px] md:h-[440px]", modelUrl, showUI = true, burgerConfig = null }) {
      const mountRef = useRef(null);
      const reqRef = useRef(null);
      const stateRef = useRef({ THREE: null, scene: null, camera: null, renderer: null, root: null, stack: null, animatables: [], matCache: null });
      const [err, setErr] = useState(null);
      const [autoRotate, setAutoRotate] = useState(true);
      
      const yawRef = useRef(0);
      const pitchRef = useRef(-0.12);
      const draggingRef = useRef(false);
      const lastRef = useRef({ x: 0, y: 0 });
      const autoRotateRef = useRef(true);
      useEffect(() => { autoRotateRef.current = autoRotate; }, [autoRotate]);

      // 1. Setup inicial del motor (una sola vez)
      useEffect(() => {
        try {
          const THREE = window.THREE;
          if (!THREE) throw new Error("Three.js no se cargó.");
          const mount = mountRef.current;
          if (!mount) return;

          const getSize = () => {
            const r = mount.getBoundingClientRect();
            return { w: Math.max(1, Math.floor(r.width)), h: Math.max(1, Math.floor(r.height)) };
          };
          const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
          renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
          renderer.outputColorSpace = THREE.SRGBColorSpace;
          renderer.toneMapping = THREE.ACESFilmicToneMapping;
          renderer.toneMappingExposure = 1.2;
          renderer.shadowMap.enabled = true;
          renderer.shadowMap.type = THREE.PCFSoftShadowMap;

          const { w, h } = getSize();
          renderer.setSize(w, h);
          renderer.domElement.style.width = "100%";
          renderer.domElement.style.height = "100%";
          renderer.domElement.style.display = "block";
          renderer.domElement.style.touchAction = "none";
          mount.appendChild(renderer.domElement);

          const scene = new THREE.Scene();
          scene.fog = new THREE.Fog(0x0a0a0f, 8, 18);
          const camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 100);

          scene.add(new THREE.AmbientLight(0xffffff, 0.16));
          scene.add(new THREE.HemisphereLight(0xf5efe6, 0x07070a, 0.60));
          const key = new THREE.SpotLight(0xffffff, 2.3, 30, Math.PI / 6, 0.35, 1.2);
          key.position.set(4.5, 6.0, 3.2); key.castShadow = true; key.shadow.mapSize.set(1024, 1024);
          scene.add(key);
          const rim = new THREE.DirectionalLight(0xc7a35c, 0.85); rim.position.set(-4.0, 2.2, -3.2); scene.add(rim);
          const fill = new THREE.DirectionalLight(0xe6d3a3, 0.55); fill.position.set(-4.2, 2.2, 2.5); scene.add(fill);

          const ground = new THREE.Mesh(new THREE.PlaneGeometry(30, 30), new THREE.ShadowMaterial({ opacity: 0.20 }));
          ground.rotation.x = -Math.PI / 2; ground.position.y = -1.25; ground.receiveShadow = true;
          scene.add(ground);

          const root = new THREE.Group();
          root.position.set(0, -0.2, 0); // Mejor centrado vertical
          scene.add(root);
          const stack = new THREE.Group();
          root.add(stack);

          // Controladores de giro
          const el = renderer.domElement;
          const onDown = (e) => { draggingRef.current = true; lastRef.current = { x: e.clientX, y: e.clientY }; el.setPointerCapture?.(e.pointerId); };
          const onMove = (e) => {
            if (!draggingRef.current) return;
            const dx = e.clientX - lastRef.current.x; const dy = e.clientY - lastRef.current.y;
            lastRef.current = { x: e.clientX, y: e.clientY };
            yawRef.current += dx * 0.008; pitchRef.current += dy * 0.006;
            pitchRef.current = Math.max(-0.75, Math.min(0.35, pitchRef.current));
          };
          const onUp = (e) => { draggingRef.current = false; try { el.releasePointerCapture?.(e.pointerId); } catch {} };
          el.addEventListener("pointerdown", onDown, { passive: true });
          el.addEventListener("pointermove", onMove, { passive: true });
          window.addEventListener("pointerup", onUp, { passive: true });

          const onResize = () => { const { w: nw, h: nh } = getSize(); camera.aspect = nw / nh; camera.updateProjectionMatrix(); renderer.setSize(nw, nh); };
          window.addEventListener("resize", onResize);

          // Cache de materiales para optimizar
          const bunNoise = makeNoiseTexture(THREE, { contrast: 0.45 });
          const meatNoise = makeNoiseTexture(THREE, { contrast: 0.65 });
          const matCache = {
            bun: new THREE.MeshPhysicalMaterial({ color: 0xc7a35c, roughness: 0.55, bumpMap: bunNoise, bumpScale: 0.08 }),
            meat: new THREE.MeshStandardMaterial({ color: 0x341b12, roughness: 0.92, bumpMap: meatNoise, bumpScale: 0.14 }),
            cheese: new THREE.MeshPhysicalMaterial({ color: 0xf2c24f, roughness: 0.38, clearcoat: 0.25 }),
            green: new THREE.MeshStandardMaterial({ color: 0x3f8f5a, roughness: 0.85 }),
            red: new THREE.MeshStandardMaterial({ color: 0xb33b2e, roughness: 0.68 }),
            generic: new THREE.MeshStandardMaterial({ color: 0x8a6a4c, roughness: 0.9 })
          };

          stateRef.current = { THREE, scene, camera, renderer, root, stack, animatables: [], matCache };

          const animate = () => {
            reqRef.current = requestAnimationFrame(animate);
            if (stateRef.current.root) {
              if (autoRotateRef.current && !draggingRef.current) yawRef.current += 0.0032;
              stateRef.current.root.rotation.y = yawRef.current;
              stateRef.current.root.rotation.x = pitchRef.current;
            }
            // Físicas de caída (Resorte)
            const time = performance.now() * 0.001;
            stateRef.current.animatables.forEach(item => {
              if (time > item.startTime) {
                const diff = item.targetY - item.mesh.position.y;
                item.velocity += diff * 0.25; // Rigidez del resorte
                item.velocity *= 0.65; // Amortiguación
                item.mesh.position.y += item.velocity;
              }
            });
            renderer.render(scene, camera);
          };
          animate();

          return () => {
            window.removeEventListener("resize", onResize);
            el.removeEventListener("pointerdown", onDown); el.removeEventListener("pointermove", onMove); window.removeEventListener("pointerup", onUp);
            cancelAnimationFrame(reqRef.current);
            renderer.dispose();
            if (mount.contains(renderer.domElement)) mount.removeChild(renderer.domElement);
            stateRef.current = { animatables: [] };
          };
        } catch (e) { setErr(e?.message || String(e)); }
      }, []);

      // 2. Manejador dinámico de ingredientes
      useEffect(() => {
        const st = stateRef.current;
        if (!st.THREE || !st.stack) return;
        const { THREE, stack, camera, matCache } = st;

        // Limpiamos la hamburguesa anterior
        while (stack.children.length) stack.remove(stack.children[0]);
        st.animatables = [];

        // Base por defecto si no hay config
        const fallbackConfig = [{ type: 'bunBottom' }, { type: 'meat' }, { type: 'cheese' }, { type: 'lettuce' }, { type: 'tomato' }, { type: 'bunTop' }];
        const currentConfig = burgerConfig || fallbackConfig;

        if (modelUrl && THREE.GLTFLoader) {
          const loader = new THREE.GLTFLoader();
          loader.load(modelUrl, (gltf) => {
            const model = gltf.scene;
            model.traverse((o) => { if (o.isMesh) { o.castShadow = true; o.receiveShadow = true; } });
            model.scale.setScalar(1.2);
            // La prearmada entera cae
            model.position.y = 5;
            st.animatables.push({ mesh: model, targetY: 0, startTime: performance.now() * 0.001, velocity: 0 });
            stack.add(model);
            
            model.position.y = 0; // Fake target para calcular centro de camara
            fitCameraToObject(THREE, camera, stack, 1.4);
            model.position.y = 5; // Reset a cielo
          }, undefined, () => buildProcedural(currentConfig));
        } else {
          buildProcedural(currentConfig);
        }

        function buildProcedural(config) {
          let currentY = -0.5; // Empezar de más abajo para mejor centro visual
          const anims = [];
          const now = performance.now() * 0.001;

          config.forEach((item, idx) => {
            let mesh, thickness;
            if (item.type === 'bunBottom') { mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.92, 1.02, 0.26, 64), matCache.bun); thickness = 0.26; }
            else if (item.type === 'meat') { mesh = new THREE.Mesh(new THREE.CylinderGeometry(1.04, 1.04, 0.28, 64), matCache.meat); thickness = 0.28; }
            else if (item.type === 'cheese') { mesh = new THREE.Mesh(new THREE.CylinderGeometry(1.07, 1.07, 0.08, 64), matCache.cheese); thickness = 0.08; }
            else if (item.type === 'lettuce') { mesh = new THREE.Mesh(new THREE.TorusGeometry(0.78, 0.12, 14, 90), matCache.green); mesh.rotation.x = Math.PI / 2; thickness = 0.15; }
            else if (item.type === 'tomato') {
              mesh = new THREE.Group();
              for (let i = 0; i < 3; i++) {
                const t = new THREE.Mesh(new THREE.CylinderGeometry(0.28, 0.28, 0.06, 48), matCache.red);
                t.position.set(Math.cos(i * 2.2) * 0.45, 0, Math.sin(i * 2.2) * 0.45);
                mesh.add(t);
              }
              thickness = 0.06;
            } else if (item.type === 'bunTop') { mesh = new THREE.Mesh(new THREE.SphereGeometry(0.95, 64, 48, 0, Math.PI * 2, 0, Math.PI / 1.9), matCache.bun); mesh.scale.set(1.0, 0.62, 1.0); thickness = 0.4; }
            else { mesh = new THREE.Mesh(new THREE.CylinderGeometry(0.85, 0.85, 0.05, 32), matCache.generic); thickness = 0.05; }

            if (mesh) {
              mesh.traverse((m) => { if(m.isMesh){ m.castShadow = true; m.receiveShadow = true; }});
              stack.add(mesh);
              const targetY = currentY + thickness / 2;
              mesh.position.y = targetY; // set temporal para la cámara
              anims.push({ mesh, targetY, startTime: now + idx * 0.15, velocity: 0 });
              currentY += thickness;
            }
          });

          // Ajustamos cámara con las piezas en su sitio final
          fitCameraToObject(THREE, camera, stack, 1.4);
          
          // Elevamos las piezas al cielo para que caigan una por una!
          anims.forEach(a => { a.mesh.position.y = a.targetY + 6; });
          st.animatables = anims;
        }
      }, [modelUrl, burgerConfig]);

      if (err) return (<div className={`${heightClass} w-full rounded-2xl border border-divineLine bg-black/20 p-4`}><div className="text-xs tracking-[0.28em] text-divineGold/90">3D</div><div className="mt-2 text-sm text-divineCream/70">{err}</div></div>);

      return (
        <div className="relative w-full">
          {showUI && <div className="absolute left-3 top-3 z-10 rounded-full border border-divineLine2 bg-black/35 px-3 py-1 text-[10px] tracking-[0.28em] text-divineCream/85 backdrop-blur">360° (ARRASTRA)</div>}
          {showUI && (
            <div className="absolute bottom-3 left-3 z-10 flex gap-2">
              <button onClick={() => setAutoRotate((s) => !s)} className="btn-ghost py-2 px-4" type="button">{autoRotate ? "PAUSAR" : "AUTO"}</button>
              <button onClick={() => { yawRef.current = 0; pitchRef.current = -0.12; }} className="btn-ghost py-2 px-4" type="button">REINICIAR</button>
            </div>
          )}
          <div ref={mountRef} className={`${heightClass} w-full bg-gradient-to-b from-black/0 to-black/35`}></div>
        </div>
      );
    }
    // =========================
    // Modales y Carrito
    // =========================
    function BottomSheet({ title, subtitle, onClose, children, cta }) {
      const close = useHistoryClose(true, onClose); useEscape(close, true);
      return (
        <motion.div className="fixed inset-0 z-50" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/70" onClick={close}></div>
          <motion.div initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }} transition={{ type: "spring", stiffness: 260, damping: 28 }} drag="y" dragConstraints={{ top: 0, bottom: 0 }} dragElastic={0.18} onDragEnd={(e, info) => { if ((info?.offset?.y ?? 0) > 120 || (info?.velocity?.y ?? 0) > 900) close(); }} className="absolute left-0 right-0 bottom-0 rounded-t-3xl border border-divineLine2 bg-divineInk shadow-divine" style={{ paddingBottom: "calc(0.75rem + env(safe-area-inset-bottom))" }} onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-center pt-3"><div className="sheet-handle"></div></div>
            <div className="px-4 pt-3 pb-3 border-b border-divineLine2 bg-black/20 backdrop-blur">
              <div className="flex items-start justify-between gap-3">
                <div className="min-w-0"><div className="text-[10px] tracking-[0.35em] text-divineGold/90">{title}</div>{subtitle && <div className="mt-1 text-sm text-divineCream/80 truncate">{subtitle}</div>}</div>
                <button className="btn-ghost py-2 px-4" onClick={close} type="button">✕ CERRAR</button>
              </div>
            </div>
            <div className="max-h-[72vh] overflow-y-auto scroll-smooth-ios overscroll-contain px-4 py-4">{children}</div>
            {cta && <div className="px-4 pt-2">{cta}</div>}
          </motion.div>
        </motion.div>
      );
    }
    function ProductModal({ product, onClose, onAdd }) {
      const isMobile = useIsMobile(); useLockBodyScroll(true);
      const viewer = <BurgerViewer3D heightClass={isMobile ? "h-[240px]" : "h-[360px] lg:h-[520px]"} modelUrl={product.modelUrl} burgerConfig={product.config} showUI={true} />;
      
      if (isMobile) {
        return (
          <BottomSheet title="COLECCIÓN DIVINÉE" subtitle={product.name} onClose={onClose} cta={<button onClick={onAdd} className="w-full btn-primary" type="button">AÑADIR AL CARRITO · {money(product.price)}</button>}>
            <div className="rounded-2xl border border-divineLine2 bg-black/20 overflow-hidden">{viewer}</div>
            <div className="mt-4 text-sm text-divineCream/70">{product.description}</div>
            <div className="mt-3 flex flex-wrap items-center gap-2"><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Peso: <span className="text-divineCream">{product.grams}g</span></span><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Precio: <span className="text-divineGold font-semibold">{money(product.price)}</span></span></div>
            <div className="mt-4 rounded-2xl border border-divineLine2 bg-divinePanel p-4"><div className="text-xs tracking-[0.28em] text-divineCream/60">INGREDIENTES</div><ul className="mt-3 space-y-2 text-sm text-divineCream/75">{product.ingredients?.map((ing) => (<li key={ing} className="flex items-center justify-between"><span>{ing}</span><span className="text-divineGold/60">•</span></li>))}</ul></div>
          </BottomSheet>
        );
      }
      const close = useHistoryClose(true, onClose); useEscape(close, true);
      return (
        <motion.div className="fixed inset-0 z-50" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/70" onClick={close}></div>
          <div className="absolute inset-0 flex items-center justify-center p-4 md:p-6">
            <motion.div initial={{ y: 18, opacity: 0, scale: 0.99 }} animate={{ y: 0, opacity: 1, scale: 1 }} exit={{ y: 14, opacity: 0, scale: 0.99 }} transition={{ duration: 0.28, ease: [0.2, 0.8, 0.2, 1] }} className="relative w-full max-w-5xl max-h-[92vh] overflow-hidden rounded-3xl border border-divineLine2 bg-divineInk shadow-divine" onClick={(e) => e.stopPropagation()}>
              <div className="sticky top-0 z-20 border-b border-divineLine2 bg-black/35 backdrop-blur px-5 py-3"><div className="flex items-center justify-between gap-3"><div className="min-w-0"><div className="text-[10px] tracking-[0.35em] text-divineGold/90">COLECCIÓN DIVINÉE</div><div className="truncate text-sm font-semibold text-divineCream">{product.name}</div></div><button onClick={close} className="btn-ghost py-2 px-4" type="button">✕ CERRAR</button></div></div>
              <div className="max-h-[92vh] overflow-y-auto scroll-smooth-ios overscroll-contain"><div className="grid grid-cols-1 lg:grid-cols-2"><div className="relative p-5"><div className="rounded-2xl border border-divineLine2 bg-black/20 overflow-hidden">{viewer}</div></div><div className="p-5 lg:p-7"><h3 className="text-2xl font-semibold">{product.name}</h3><p className="mt-2 text-sm text-divineCream/70">{product.description}</p><div className="mt-5 flex flex-wrap items-center gap-3"><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Peso: <span className="text-divineCream">{product.grams}g</span></span><span className="rounded-full border border-divineLine2 bg-divinePanel px-3 py-1 text-xs text-divineCream/80">Precio: <span className="text-divineGold font-semibold">{money(product.price)}</span></span><button onClick={onAdd} className="ml-auto btn-primary" type="button">AÑADIR</button></div><div className="mt-6 rounded-2xl border border-divineLine2 bg-divinePanel p-4"><div className="text-xs tracking-[0.28em] text-divineCream/60">INGREDIENTES</div><ul className="mt-3 space-y-2 text-sm text-divineCream/75">{product.ingredients?.map((ing) => (<li key={ing} className="flex items-center justify-between"><span>{ing}</span><span className="text-divineGold/60">•</span></li>))}</ul></div><div className="mt-6 rounded-2xl border border-divineLine2 bg-black/25 p-4"><div className="text-xs tracking-[0.28em] text-divineCream/60">NUTRICIÓN</div><div className="mt-3 grid grid-cols-2 gap-3 text-sm">{Object.entries(product.nutrition || {}).map(([k, v]) => (<div key={k} className="flex items-center justify-between rounded-xl border border-divineLine bg-divinePanel px-3 py-2"><span className="text-divineCream/70">{String(k).toUpperCase()}</span><span className="font-semibold text-divineCream">{v}</span></div>))}</div></div><div className="h-4"></div></div></div></div>
            </motion.div>
          </div>
        </motion.div>
      );
    }
    // =========================
    // Módulo de Rastreo Real (Supabase)
    // =========================
    function TrackingModal({ onClose, supabaseClient }) {
      const [inputCode, setInputCode] = useState("");
      const [statusData, setStatusData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [errorMsg, setErrorMsg] = useState("");

      const searchOrder = async () => {
        if (!inputCode) return;
        setLoading(true); setErrorMsg(""); setStatusData(null);

        const { data, error } = await supabaseClient
          .from('orders')
          .select('status, customer_name')
          .eq('tracking_code', inputCode.trim().toUpperCase())
          .single();

        if (error || !data) {
          setErrorMsg("No encontramos este código. Verifica que esté bien escrito (Ej: #DIV-1234).");
        } else {
          setStatusData(data);
        }
        setLoading(false);
      };

      return (
        <BottomSheet title="RASTREO DE PEDIDO" subtitle="Ingresa tu código de orden" onClose={onClose}>
          <div className="space-y-4">
            <input type="text" value={inputCode} onChange={(e) => setInputCode(e.target.value)} placeholder="Ej: #DIV-1234" className="w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream outline-none focus:border-divineGold transition uppercase" />
            <button className="w-full btn-primary" onClick={searchOrder} disabled={loading}>{loading ? "BUSCANDO..." : "BUSCAR ESTADO"}</button>
            {errorMsg && <div className="text-red-400 text-sm mt-2">{errorMsg}</div>}
            {statusData && (
              <div className="mt-4 p-5 rounded-2xl border border-divineLine2 bg-divinePanel">
                <div className="text-xs tracking-[0.28em] text-divineCream/60 mb-1">HOLA, {statusData.customer_name.toUpperCase()}</div>
                <div className="text-sm text-divineCream/80">El estatus actual de tu pedido es:</div>
                <div className="mt-2 text-2xl font-bold text-divineGold">{statusData.status.toUpperCase()}</div>
              </div>
            )}
          </div>
        </BottomSheet>
      );
    }
    function CartButton({ cartCount, onClick }) {
      return (
        <button onClick={onClick} className="fixed z-40 rounded-2xl border border-divineLine2 bg-black/35 px-4 py-3 shadow-glow backdrop-blur hover:brightness-110 transition floating-safe" aria-label="Abrir carrito" type="button"><div className="flex items-center gap-3"><div className="text-xs tracking-[0.28em] text-divineCream/75">CARRITO</div><div className="rounded-full bg-divineGold px-2 py-1 text-xs font-semibold text-black">{cartCount}</div></div></button>
      );
    }
// =========================
    // Cart Drawer con Checkout Integrado + Capture
    // =========================
    function CartDrawer({ items, total, bcvRate, onClose, onQty, onClearCart }) {
      useLockBodyScroll(true); 
      const close = useHistoryClose(true, onClose); 
      useEscape(close, true);
      
      const [step, setStep] = useState(0); 
      const [loading, setLoading] = useState(false);
      const [orderId, setOrderId] = useState("");
      const [formData, setFormData] = useState({ name: "", phone: "", address: "", notes: "", ref: "" });
      const [receiptFile, setReceiptFile] = useState(null);
      
      // NUEVO: Estado para el delivery
      const [deliveryZone, setDeliveryZone] = useState('retiro');
      const deliveryCost = deliveryZone === 'centro' ? 0.00 : (deliveryZone === 'afueras' ? 1.50 : 0);
      const finalTotal = total + deliveryCost;

      const handleInput = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

      const handleCheckout = async () => {
        setLoading(true);
        const newOrderId = "#DIV-" + Math.floor(1000 + Math.random() * 9000);
        
        const { error } = await supabaseClient.from('orders').insert([{
            tracking_code: newOrderId, customer_name: formData.name, phone: formData.phone,
            address: formData.address, notes: formData.notes, items: items, 
            total_usd: finalTotal, bcv_rate: bcvRate, // Usa el finalTotal
            payment_ref: formData.ref || "Capture adjunto", 
            status: 'Pendiente'
        }]);

        if (error) {
          alert("Error conectando con la base de datos.");
          setLoading(false); return;
        }

        let orderText = `🍔 *NUEVO PEDIDO* ${newOrderId}\n\n👤 *Cliente:* ${formData.name}\n📞 *Teléfono:* ${formData.phone}\n📍 *Dirección:* ${formData.address}\n🛵 *Método:* ${deliveryZone.toUpperCase()}\n`;
        if(formData.notes) orderText += `📝 *Nota:* ${formData.notes}\n`;
        orderText += `\n🛒 *PEDIDO:*\n`;
        items.forEach(it => {
          orderText += `• ${it.qty}x ${it.name} - $${(it.price * it.qty).toFixed(2)}\n`;
          if (it.meta) Object.entries(it.meta).forEach(([k, v]) => { orderText += `   _${k}:_ ${Array.isArray(v) ? v.join(", ") : String(v)}\n`; });
        });
        if (deliveryCost > 0) orderText += `\n🛵 *Costo Delivery:* $${deliveryCost.toFixed(2)}`;
        orderText += `\n💰 *Total USD:* $${finalTotal.toFixed(2)}`;
        if (bcvRate) orderText += `\n🇻🇪 *Total BCV:* ${(finalTotal * bcvRate).toFixed(2)} Bs`;
        orderText += `\n💳 *Ref PagoMóvil:* ${formData.ref || "Envió Capture"}`;

        try {
          await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: orderText, parse_mode: "Markdown" }) });
          if (receiptFile) {
            const fd = new FormData(); fd.append('chat_id', TELEGRAM_CHAT_ID); fd.append('photo', receiptFile); fd.append('caption', `📷 Capture del pedido: ${newOrderId}`);
            await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, { method: 'POST', body: fd });
          }
        } catch (e) { console.log("Telegram falló"); }
        setOrderId(newOrderId); setStep(3); onClearCart(); setLoading(false);
      };

      const handleRemoveItem = (id) => onQty(id, 0);

      return (
        <motion.div className="fixed inset-0 z-50" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} aria-modal="true" role="dialog">
          <div className="absolute inset-0 bg-black/70" onClick={close}></div>
          <motion.aside initial={{ x: 24, opacity: 0 }} animate={{ x: 0, opacity: 1 }} exit={{ x: 24, opacity: 0 }} transition={{ duration: 0.28, ease: [0.2, 0.8, 0.2, 1] }} className="absolute right-0 top-0 h-full w-[92vw] max-w-md border-l border-divineLine2 bg-divineInk shadow-divine flex flex-col" onClick={(e) => e.stopPropagation()}>
            <div className="flex-1 overflow-y-auto scroll-smooth-ios p-5 pb-10" style={{ paddingBottom: "calc(2.5rem + env(safe-area-inset-bottom))" }}>
              <div className="flex items-start justify-between">
                <div><div className="text-xs tracking-[0.35em] text-divineGold/90">{BRAND_NAME.toUpperCase()}</div><h3 className="mt-2 text-xl font-semibold">{step === 0 ? "Carrito" : step === 1 ? "Tus Datos" : step === 2 ? "Pago Móvil" : "Pedido Confirmado"}</h3></div>
                {step !== 3 && <button onClick={close} className="btn-ghost py-2 px-4" type="button">CERRAR</button>}
              </div>

              {step === 0 && (
                <>
                  <div className="mt-6 space-y-3">
                    {items.length === 0 ? (<div className="rounded-2xl border border-divineLine bg-divinePanel p-4 text-sm text-divineCream/70 text-center py-10">Tu carrito está vacío.</div>) : (
                      items.map((it) => (
                        <div key={it.id} className="rounded-2xl border border-divineLine2 bg-divinePanel p-4 relative overflow-hidden group">
                          <button onClick={() => handleRemoveItem(it.id)} className="absolute top-2 right-2 p-2 text-red-500/50 hover:text-red-400 hover:bg-red-500/10 rounded-full transition" title="Eliminar producto">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fillRule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                          </button>
                          <div className="flex items-start justify-between gap-3 pr-6"><div><div className="font-semibold">{it.name}</div><div className="mt-1 text-sm text-divineCream/70">{money(it.price)}</div></div><div className="text-sm font-semibold text-divineGold">{money(it.price * it.qty)}</div></div>
                          <div className="mt-3 flex items-center gap-2"><button className="btn-ghost py-2 px-4" onClick={() => onQty(it.id, it.qty - 1)} type="button">−</button><div className="min-w-10 text-center text-sm">{it.qty}</div><button className="btn-ghost py-2 px-4" onClick={() => onQty(it.id, it.qty + 1)} type="button">+</button></div>
                        </div>
                      ))
                    )}
                  </div>
                  {items.length > 0 && (
                    <div className="mt-6 space-y-3">
                      <div className="rounded-2xl border border-divineLine2 bg-black/25 p-4"><div className="flex items-center justify-between"><span className="text-sm text-divineCream/70">Subtotal</span><div className="text-right"><div className="text-lg font-semibold text-divineGold">{money(total)}</div></div></div><button className="mt-4 w-full btn-primary" onClick={() => setStep(1)} type="button">PROCESAR COMPRA</button></div>
                      <button onClick={onClearCart} className="w-full py-3 text-[11px] tracking-widest text-red-500/60 hover:text-red-400 hover:bg-red-500/10 border border-transparent hover:border-red-500/30 rounded-xl transition font-semibold">VACIAR CARRITO</button>
                    </div>
                  )}
                </>
              )}

              {step === 1 && (
                <div className="mt-6 space-y-4">
                  <div><label className="text-xs tracking-[0.18em] text-divineCream/60 ml-1">NOMBRE COMPLETO</label><input type="text" name="name" value={formData.name} onChange={handleInput} className="mt-1 w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream outline-none focus:border-divineGold transition" /></div>
                  <div><label className="text-xs tracking-[0.18em] text-divineCream/60 ml-1">TELÉFONO</label><input type="tel" name="phone" value={formData.phone} onChange={handleInput} className="mt-1 w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream outline-none focus:border-divineGold transition" /></div>
                  
                  {/* NUEVO: Selector de Delivery */}
                  <div>
                    <label className="text-xs tracking-[0.18em] text-divineCream/60 ml-1">MÉTODO DE ENTREGA</label>
                    <select name="deliveryZone" value={deliveryZone} onChange={(e) => setDeliveryZone(e.target.value)} className="mt-1 w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream outline-none focus:border-divineGold transition cursor-pointer">
                      <option value="retiro">Retiro por el local ($0.00)</option>
                      <option value="centro">Delivery: Pueblo Llano Centro (+$0.00)</option>
                      <option value="afueras">Delivery: Zonas alejadas (+$1.50)</option>
                    </select>
                  </div>

                  <div><label className="text-xs tracking-[0.18em] text-divineCream/60 ml-1">DIRECCIÓN DE ENTREGA</label><textarea name="address" value={formData.address} onChange={handleInput} rows={2} className="mt-1 w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream outline-none focus:border-divineGold transition" placeholder="Sector, calle, casa/apto..."></textarea></div>
                  <div><label className="text-xs tracking-[0.18em] text-divineCream/60 ml-1">NOTA ADICIONAL</label><input type="text" name="notes" value={formData.notes} onChange={handleInput} className="mt-1 w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream outline-none focus:border-divineGold transition" /></div>
                  <div className="pt-4 flex gap-3"><button className="btn-ghost flex-1" onClick={() => setStep(0)}>ATRÁS</button><button className="btn-primary flex-1" onClick={() => setStep(2)} disabled={!formData.name || !formData.phone || (deliveryZone !== 'retiro' && !formData.address)} style={{opacity: (!formData.name || !formData.phone || (deliveryZone !== 'retiro' && !formData.address)) ? 0.5 : 1}}>PAGAR</button></div>
                </div>
              )}

              {step === 2 && (
                <div className="mt-6 space-y-4">
                  <div className="rounded-2xl border border-divineLine2 bg-divinePanel p-5 space-y-3">
                    <div className="text-center pb-2 border-b border-divineLine2">
                      <div className="text-xs tracking-[0.28em] text-divineCream/60 mb-1">TOTAL A TRANSFERIR</div>
                      <div className="text-2xl font-semibold text-divineGold">{bcvRate ? moneyVES(finalTotal, bcvRate) : money(finalTotal)}</div>
                      <div className="text-[10px] text-divineCream/50 mt-1">Pedido: {money(total)} {deliveryCost > 0 && `+ Delivery: ${money(deliveryCost)}`}</div>
                    </div>
                    <div><span className="text-xs text-divineCream/50 block">Banco</span><span className="font-semibold tracking-wider">PROVINCIAL (0108)</span></div>
                    <div><span className="text-xs text-divineCream/50 block">Teléfono</span><span className="font-semibold tracking-wider">0412 683 5635</span></div>
                    <div><span className="text-xs text-divineCream/50 block">Cédula/RIF</span><span className="font-semibold tracking-wider">V-30158858</span></div>
                  </div>
                  <div><label className="text-xs tracking-[0.18em] text-divineGold ml-1">REFERENCIA (Opcional si subes capture)</label><input type="number" name="ref" value={formData.ref} onChange={handleInput} className="mt-1 w-full bg-black/60 border border-divineGold/50 rounded-xl px-4 py-3 text-lg font-semibold text-divineCream outline-none focus:border-divineGold transition text-center tracking-widest" placeholder="Últimos dígitos" /></div>
                  <div><label className="text-xs tracking-[0.18em] text-divineCream/60 ml-1">O SUBE TU CAPTURE</label><input type="file" accept="image/*" onChange={(e) => setReceiptFile(e.target.files[0])} className="mt-1 w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-divineGold file:text-black hover:file:bg-divineGold2" /></div>
                  <div className="pt-4 flex gap-3"><button className="btn-ghost flex-1" onClick={() => setStep(1)} disabled={loading}>ATRÁS</button><button className="btn-primary flex-1" onClick={handleCheckout} disabled={(!formData.ref && !receiptFile) || loading} style={{opacity: ((!formData.ref && !receiptFile) || loading) ? 0.5 : 1}}>{loading ? "PROCESANDO..." : "CONFIRMAR PAGO"}</button></div>
                </div>
              )}

              {step === 3 && (
                <div className="mt-10 flex flex-col items-center text-center space-y-4"><div className="w-16 h-16 rounded-full border-2 border-divineGold text-divineGold flex items-center justify-center text-2xl">✓</div><h3 className="text-2xl font-semibold">¡Pedido Recibido!</h3><p className="text-sm text-divineCream/70">Estamos verificando tu pago para preparar tu orden.</p><div className="w-full mt-6 p-5 rounded-2xl border border-divineLine2 bg-black/30"><div className="text-xs tracking-[0.28em] text-divineCream/60 mb-2">CÓDIGO DE RASTREO</div><div className="text-3xl font-bold tracking-widest text-divineGold">{orderId}</div><p className="mt-3 text-xs text-divineCream/50">Con este código puedes revisar el estado de tu pedido en la página principal.</p></div><button className="mt-6 w-full btn-ghost" onClick={close}>VOLVER AL MENÚ</button></div>
              )}
            </div>
          </motion.aside>
        </motion.div>
      );
    }
    
    // =========================
    // App Base
    // =========================
// =========================
    // App Base
    // =========================
// =========================
    // Atelier (Burger Builder)
    // =========================
    const BURGER_BASE = 0.00;
    const BURGER_CATALOG = {
      buns: [
        { id: "brioche", name: "Brioche", price: 1.75, note: "Suave, dorado, premium" },
        { id: "potato", name: "Potato Roll", price: 1.50, note: "Esponjoso, balanceado" },
        { id: "sesame", name: "Sésamo", price: 1.25, note: "Clásico, crujiente" },
        { id: "pretzel", name: "Pretzel", price: 1.95, note: "Más denso, elegante" },
        { id: "ciabatta", name: "Ciabatta", price: 1.85, note: "Textura artesanal" },
        { id: "lettuce", name: "Lettuce Wrap", price: 0.95, note: "Fresco, low-carb" },
      ],
        proteins: [
        { id: "angus180", name: "Lomito Premium", price: 3.50, note: "Corte de res tierno" },
        { id: "smash", name: "Carne Smash", price: 2.50, note: "Corte caramelizado" },
        { id: "lomoCerdo", name: "Lomo de Cerdo", price: 3.20, note: "Sabor ahumado" },
        { id: "chorizo", name: "Chorizo Premium", price: 2.50, note: "Toque artesanal" },
        { id: "chickenGrilled", name: "Pollo a la Plancha", price: 2.25, note: "Ligero y tierno" },
      ],
      cheeses: [
        { id: "cheddar", name: "Cheddar Añejo", price: 0.80, note: "Clásico lujo" },
        { id: "gruyere", name: "Llanero", price: 0.50, note: "Blanco Delicia" },
        { id: "swiss", name: "Suizo", price: 1.50, note: "Suave, elástico" },
        { id: "blue", name: "Azul Suave", price: 1.95, note: "Umami elegante" },
        { id: "pepperJack", name: "Pepper Jack", price: 1.65, note: "Picante sutil" },
        { id: "none", name: "Sin queso", price: 0.0, note: "Limpio, directo" },
      ],
      toppings: [
        { id: "bacon", name: "Jamón de Pierna", price: 0.50, group: "Crunch" },
        { id: "pickles", name: "Pepinillos", price: 0.70, group: "Classic" },
        { id: "lettuce", name: "Lechuga", price: 0.60, group: "Fresh" },
        { id: "arugula", name: "Jamón Ahumado", price: 0.85, group: "Fresh" },
        { id: "tomato", name: "Tomate", price: 0.65, group: "Fresh" },
        { id: "tocino", name: "Tocineta", price: 0.80, group: "Crunch" },
        { id: "mushrooms", name: "Hongos (Champiñones)", price: 1.25, group: "Umami" },
        { id: "caramelOnion", name: "Cebolla caramelizada", price: 0.50, group: "Classic" },
        { id: "crispyOnion", name: "Cebolla crujiente", price: 0.50, group: "Crunch" },
        { id: "egg", name: "Huevo", price: 0.60, group: "Luxe" },
        { id: "avocado", name: "Aguacate", price: 0.80, group: "Luxe" },
        { id: "hashbrown", name: "Cebolla", price: 0.20, group: "Crunch" },
        { id: "papashilo", name: "Papas Hilo", price: 0.60, group: "Crunch" },
        { id: "divineeSauce", name: "Adi Salsas Divinée", price: 0.50, group: "Sauce" },
        { id: "aioli", name: "Alioli", price: 0.90, group: "Sauce" },
        { id: "bbq", name: "BBQ", price: 0.90, group: "Sauce" },
        { id: "spicyMayo", name: "Mayo spicy", price: 0.95, group: "Sauce" },
        { id: "truffle", name: "Trufa", price: 2.40, group: "Luxe" },
      ],
    };

    const MAX_PROTEIN_LAYERS = 4;
    const MAX_CHEESE_LAYERS = 4;

    function wrapIndex(i, len) {
      if (len <= 0) return 0;
      return (i % len + len) % len;
    }

    function IconButton({ label, onClick, title }) {
      return (
        <button onClick={onClick} title={title} className="btn-ghost px-4 py-2" type="button">
          {label}
        </button>
      );
    }

    function CarouselPicker({ title, options, index, onPrev, onNext, disabledItems = [] }) {
      const opt = options[index];
      const isExhausted = disabledItems.includes(opt?.id);
      return (
        <div className={`rounded-3xl border ${isExhausted ? 'border-red-500/40 bg-red-500/5' : 'border-divineLine2 bg-black/20'} p-4 transition-colors`}>
          <div className="text-xs tracking-[0.35em] text-divineGold/90">{title.toUpperCase()}</div>
          <div className="mt-3 grid grid-cols-[auto_1fr_auto] items-center gap-3">
            <IconButton label="←" title="Anterior" onClick={onPrev} />
            <motion.div key={opt?.id} initial={{ opacity: 0, y: 8 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.18 }} className="rounded-2xl border border-divineLine2 bg-divinePanel p-4">
              <div className="flex items-start justify-between gap-3">
                <div>
                  <div className="text-base font-semibold">
                    {opt?.name} 
                    {isExhausted && <span className="ml-2 inline-block rounded-full bg-red-500/20 border border-red-500/50 px-2 py-0.5 text-[9px] font-bold text-red-400 tracking-widest align-middle">AGOTADO</span>}
                  </div>
                  <div className="mt-1 text-sm text-divineCream/65">{opt?.note}</div>
                </div>
                <div className="text-sm font-semibold text-divineGold">{money(opt?.price ?? 0)}</div>
              </div>
            </motion.div>
            <IconButton label="→" title="Siguiente" onClick={onNext} />
          </div>
        </div>
      );
    }

    function LayersHeader({ title, count, onAdd, addLabel, disabled }) {
      return (
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div className="text-xs tracking-[0.35em] text-divineGold/90">{title.toUpperCase()}</div>
            <div className="mt-1 text-sm text-divineCream/65">Capas: <span className="text-divineCream">{count}</span></div>
          </div>
          <button type="button" onClick={onAdd} className="btn-ghost px-4 py-2" disabled={disabled} style={{ opacity: disabled ? 0.55 : 1 }}>
            + <span className="ml-1">{addLabel}</span>
          </button>
        </div>
      );
    }

    function LayersTabs({ label, layers, active, setActive, onRemove, min = 1 }) {
      return (
        <div className="mt-3 flex gap-2 overflow-x-auto scroll-smooth-ios pb-1 mobile-scroll">
          {layers.map((_, i) => (
            <div key={i} className="flex items-center gap-1">
              <button type="button" onClick={() => setActive(i)} className={["whitespace-nowrap rounded-full border px-3 py-2 text-[11px] tracking-[0.22em] transition backdrop-blur", active === i ? "border-divineGold/60 bg-black/35 text-divineGold shadow-glow" : "border-divineLine2 bg-black/25 text-divineCream/70 hover:text-divineGold hover:border-divineGold/40"].join(" ")}>{label.toUpperCase()} {i + 1}</button>
              {layers.length > min && (<button type="button" onClick={() => onRemove(i)} className="rounded-full border border-divineLine2 bg-black/25 px-2 py-2 text-[11px] text-divineCream/70 hover:text-divineGold hover:border-divineGold/40 transition" title="Eliminar capa">×</button>)}
            </div>
          ))}
        </div>
      );
    }

    function BurgerBuilder({ onAddToCart }) {
      const [step, setStep] = useState(0);
      const [bunIdx, setBunIdx] = useState(0);
      const [proteinLayers, setProteinLayers] = useState([0]);
      const [activeProteinLayer, setActiveProteinLayer] = useState(0);
      const [cheeseLayers, setCheeseLayers] = useState([5]); 
      const [activeCheeseLayer, setActiveCheeseLayer] = useState(0);
      const [toppings, setToppings] = useState([]);
      
      const [disabledItems, setDisabledItems] = useState([]);

      useEffect(() => {
        const fetchInventory = async () => {
          if(!window.supabase) return;
          const { data } = await supabaseClient.from('disabled_ingredients').select('id');
          if (data) setDisabledItems(data.map(i => i.id));
        };
        fetchInventory();
      }, []);

      const bun = BURGER_CATALOG.buns[bunIdx];
      const cheesesCount = Math.max(0, cheeseLayers.filter((idx) => BURGER_CATALOG.cheeses[idx]?.id !== "none").length);

      const price = useMemo(() => {
        const bunP = bun?.price ?? 0;
        const proteinsP = proteinLayers.reduce((acc, idx) => acc + (BURGER_CATALOG.proteins[idx]?.price ?? 0), 0);
        const cheesesP = cheeseLayers.reduce((acc, idx) => acc + (BURGER_CATALOG.cheeses[idx]?.price ?? 0), 0);
        const toppingsP = toppings.reduce((acc, id) => acc + (BURGER_CATALOG.toppings.find((t) => t.id === id)?.price ?? 0), 0);
        return BURGER_BASE + bunP + proteinsP + cheesesP + toppingsP;
      }, [bunIdx, proteinLayers, cheeseLayers, toppings]);

      const dynamicConfig = useMemo(() => {
        const conf = [{ type: 'bunBottom' }];
        proteinLayers.forEach(() => conf.push({ type: 'meat' }));
        cheeseLayers.forEach((idx) => { if (BURGER_CATALOG.cheeses[idx]?.id !== 'none') conf.push({ type: 'cheese' }); });
        toppings.forEach(id => {
          if (id === 'lettuce' || id === 'arugula') conf.push({ type: 'lettuce' });
          else if (id === 'tomato') conf.push({ type: 'tomato' });
          else conf.push({ type: 'generic' });
        });
        conf.push({ type: 'bunTop' });
        return conf;
      }, [proteinLayers, cheeseLayers, toppings]);

      // LÓGICA DE VALIDACIÓN INVENTARIO
      const isBunDisabled = disabledItems.includes(bun?.id);
      const hasDisabledProtein = proteinLayers.some(idx => disabledItems.includes(BURGER_CATALOG.proteins[idx]?.id));
      const hasDisabledCheese = cheeseLayers.some(idx => disabledItems.includes(BURGER_CATALOG.cheeses[idx]?.id));
      const hasDisabledTopping = toppings.some(id => disabledItems.includes(id));
      
      const hasAnyError = isBunDisabled || hasDisabledProtein || hasDisabledCheese || hasDisabledTopping;
      const valid = proteinLayers.length >= 1 && !hasAnyError;

      const steps = ["PAN", "CARNES", "QUESOS", "TOPPINGS"];

      function toggleTopping(id) { setToppings((prev) => (prev.includes(id) ? prev.filter((x) => x !== id) : [...prev, id])); }
      function bunPrev() { setBunIdx((i) => wrapIndex(i - 1, BURGER_CATALOG.buns.length)); }
      function bunNext() { setBunIdx((i) => wrapIndex(i + 1, BURGER_CATALOG.buns.length)); }
      function proteinPrev() { setProteinLayers((layers) => { const copy = [...layers]; copy[activeProteinLayer] = wrapIndex(copy[activeProteinLayer] - 1, BURGER_CATALOG.proteins.length); return copy; }); }
      function proteinNext() { setProteinLayers((layers) => { const copy = [...layers]; copy[activeProteinLayer] = wrapIndex(copy[activeProteinLayer] + 1, BURGER_CATALOG.proteins.length); return copy; }); }
      function addProteinLayer() { setProteinLayers((layers) => { if (layers.length >= MAX_PROTEIN_LAYERS) return layers; return [...layers, layers[layers.length - 1] ?? 0]; }); setActiveProteinLayer((i) => Math.min(i + 1, MAX_PROTEIN_LAYERS - 1)); }
      function removeProteinLayer(i) { setProteinLayers((layers) => layers.filter((_, idx) => idx !== i)); setActiveProteinLayer((cur) => (cur > 0 ? cur - 1 : 0)); }
      function cheesePrev() { setCheeseLayers((layers) => { const copy = [...layers]; copy[activeCheeseLayer] = wrapIndex(copy[activeCheeseLayer] - 1, BURGER_CATALOG.cheeses.length); return copy; }); }
      function cheeseNext() { setCheeseLayers((layers) => { const copy = [...layers]; copy[activeCheeseLayer] = wrapIndex(copy[activeCheeseLayer] + 1, BURGER_CATALOG.cheeses.length); return copy; }); }
      function addCheeseLayer() { setCheeseLayers((layers) => { if (layers.length >= MAX_CHEESE_LAYERS) return layers; return [...layers, layers[layers.length - 1] ?? 0]; }); setActiveCheeseLayer((i) => Math.min(i + 1, MAX_CHEESE_LAYERS - 1)); }
      function removeCheeseLayer(i) { setCheeseLayers((layers) => layers.filter((_, idx) => idx !== i)); setActiveCheeseLayer((cur) => (cur > 0 ? cur - 1 : 0)); }

      function buildAndAdd() {
        if (!valid) return;
        const bunSel = BURGER_CATALOG.buns[bunIdx];
        const proteinsSel = proteinLayers.map((idx) => BURGER_CATALOG.proteins[idx]).filter(Boolean);
        const cheesesSel = cheeseLayers.map((idx) => BURGER_CATALOG.cheeses[idx]).filter(Boolean);
        const toppingsSel = toppings.map((id) => BURGER_CATALOG.toppings.find((t) => t.id === id)).filter(Boolean);
        
        const id = ["custom-burger", bunSel?.id, proteinsSel.map((p) => p.id).join("+"), cheesesSel.map((c) => c.id).join("+"), toppings.slice().sort().join(",")].join(":");
        const meta = { pan: bunSel?.name, carnes: proteinsSel.map((p) => p.name), quesos: cheesesSel.map((c) => c.name), toppings: toppingsSel.map((t) => t.name) };
        
        onAddToCart?.({ id, name: "Hamburguesa Divinée (Atelier)", price, meta });
        setStep(0); setBunIdx(0); setProteinLayers([0]); setActiveProteinLayer(0); setCheeseLayers([5]); setActiveCheeseLayer(0); setToppings([]);
      }

      return (
        <div className="rounded-3xl glass ring-gold p-4 md:p-6">
          <div className="flex flex-wrap items-start justify-between gap-3">
            <div>
              <div className="text-xs tracking-[0.35em] text-divineGold/90">ATELIER</div>
              <h3 className="mt-2 text-xl font-semibold md:text-2xl">Arma tu Hamburguesa</h3>
              <p className="mt-1 text-sm text-divineCream/65">Carrusel + capas múltiples.</p>
            </div>
            <div className="rounded-2xl border border-divineLine2 bg-black/25 px-4 py-3 shadow-glow">
              <div className="text-[10px] tracking-[0.28em] text-divineCream/55">PRECIO</div>
              <div className="mt-1 text-lg font-semibold text-divineGold">{money(price)}</div>
            </div>
          </div>
          
          <div className="mt-5 rounded-3xl border border-divineLine2 bg-black/20 overflow-hidden">
            <div className="flex items-center justify-between px-4 py-3 border-b border-divineLine2 bg-black/25">
              <div>
                <div className="text-xs tracking-[0.35em] text-divineGold/90">VISTA 3D</div>
              </div>
              <div className="text-xs tracking-[0.22em] text-divineCream/55">
                {proteinLayers.length} carne(s) • {cheesesCount} queso(s)
              </div>
            </div>
            <BurgerViewer3D heightClass="h-[240px] md:h-[320px]" modelUrl={null} burgerConfig={dynamicConfig} showUI={false} />
          </div>

          {hasAnyError && (
            <div className="mt-5 p-3 rounded-xl border border-red-500/50 bg-red-500/10 text-red-400 text-sm font-semibold text-center">
              ⚠️ Tienes ingredientes AGOTADOS seleccionados. Cámbialos para poder armar la hamburguesa.
            </div>
          )}

          <div className="mt-5 grid grid-cols-4 gap-2">
            {steps.map((label, i) => (
              <button key={label} onClick={() => setStep(i)} className={["rounded-2xl border px-3 py-2 text-[11px] tracking-[0.22em] transition", step === i ? "border-divineGold/60 bg-black/35 text-divineGold shadow-glow" : "border-divineLine bg-black/25 text-divineCream/70 hover:text-divineGold hover:border-divineGold/40"].join(" ")} type="button">
                {label}
              </button>
            ))}
          </div>

          <motion.div key={step} initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.25 }} className="mt-5">
            {step === 0 && (
              <CarouselPicker title="Pan" options={BURGER_CATALOG.buns} index={bunIdx} onPrev={bunPrev} onNext={bunNext} disabledItems={disabledItems} />
            )}
            {step === 1 && (
              <div className="space-y-4">
                <LayersHeader title="Carnes" count={proteinLayers.length} onAdd={addProteinLayer} addLabel="Agregar otra carne" disabled={proteinLayers.length >= MAX_PROTEIN_LAYERS} />
                <LayersTabs label="Carne" layers={proteinLayers} active={activeProteinLayer} setActive={setActiveProteinLayer} onRemove={removeProteinLayer} min={1} />
                <CarouselPicker title={`Carne ${activeProteinLayer + 1}`} options={BURGER_CATALOG.proteins} index={proteinLayers[activeProteinLayer] ?? 0} onPrev={proteinPrev} onNext={proteinNext} disabledItems={disabledItems} />
              </div>
            )}
            {step === 2 && (
              <div className="space-y-4">
                <LayersHeader title="Quesos" count={cheeseLayers.length} onAdd={addCheeseLayer} addLabel="Agregar otro queso" disabled={cheeseLayers.length >= MAX_CHEESE_LAYERS} />
                <LayersTabs label="Queso" layers={cheeseLayers} active={activeCheeseLayer} setActive={setActiveCheeseLayer} onRemove={removeCheeseLayer} min={1} />
                <CarouselPicker title={`Queso ${activeCheeseLayer + 1}`} options={BURGER_CATALOG.cheeses} index={cheeseLayers[activeCheeseLayer] ?? 0} onPrev={cheesePrev} onNext={cheeseNext} disabledItems={disabledItems} />
              </div>
            )}
            {step === 3 && (
              <div className="rounded-3xl border border-divineLine2 bg-black/20 p-4">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="text-xs tracking-[0.35em] text-divineGold/90">TOPPINGS</div>
                    <div className="mt-1 text-sm text-divineCream/65">Selecciona todos los que quieras.</div>
                  </div>
                  <div className="text-xs tracking-[0.22em] text-divineCream/55">{toppings.length} seleccionados</div>
                </div>
                <div className="mt-4 grid gap-2 sm:grid-cols-2">
                  {BURGER_CATALOG.toppings.map((t) => {
                    const active = toppings.includes(t.id);
                    const isExhausted = disabledItems.includes(t.id);
                    return (
                      <button key={t.id} onClick={() => !isExhausted && toggleTopping(t.id)} className={`rounded-2xl border px-4 py-3 text-left transition ${isExhausted ? 'border-red-500/30 bg-red-500/5 cursor-not-allowed opacity-60' : (active ? 'border-divineGold/60 bg-black/35 shadow-glow' : 'border-divineLine bg-black/25 hover:border-divineGold/40')}`} type="button">
                        <div className="flex items-start justify-between gap-3">
                          <div>
                            <div className={`font-semibold ${isExhausted ? 'text-red-400 line-through' : ''}`}>{t.name}</div>
                            <div className="mt-1 text-xs tracking-[0.18em] text-divineCream/55">
                              {isExhausted ? <span className="text-red-400 font-bold">AGOTADO</span> : t.group.toUpperCase()}
                            </div>
                          </div>
                          <div className="text-sm font-semibold text-divineGold">{money(t.price)}</div>
                        </div>
                      </button>
                    );
                  })}
                </div>
              </div>
            )}
          </motion.div>

          <div className="mt-8 rounded-2xl border border-divineLine2 bg-divinePanel p-4">
            <div className="text-[10px] tracking-[0.28em] text-divineCream/60 mb-3">DESGLOSE DEL PEDIDO</div>
            <div className="space-y-2 text-sm text-divineCream/75">
              <div className="flex justify-between"><span>Salsas Divinée</span><span>{money(BURGER_BASE)}</span></div>
              <div className={`flex justify-between ${isBunDisabled ? 'text-red-400 line-through' : ''}`}><span>{bun?.name}</span><span>{money(bun?.price ?? 0)}</span></div>
              
              {proteinLayers.map((idx, i) => {
                const p = BURGER_CATALOG.proteins[idx];
                if (!p) return null;
                return <div key={`p-${i}`} className={`flex justify-between ${disabledItems.includes(p.id) ? 'text-red-400 line-through' : ''}`}><span>{p.name}</span><span>{money(p.price)}</span></div>;
              })}
              
              {cheeseLayers.map((idx, i) => {
                const c = BURGER_CATALOG.cheeses[idx];
                if (!c || c.id === 'none') return null;
                return <div key={`c-${i}`} className={`flex justify-between ${disabledItems.includes(c.id) ? 'text-red-400 line-through' : ''}`}><span>{c.name}</span><span>{money(c.price)}</span></div>;
              })}
              
              {toppings.map((id) => {
                const t = BURGER_CATALOG.toppings.find((x) => x.id === id);
                if (!t) return null;
                return <div key={id} className={`flex justify-between ${disabledItems.includes(id) ? 'text-red-400 line-through' : ''}`}><span>{t.name}</span><span>{money(t.price)}</span></div>;
              })}
            </div>
            <div className="mt-3 pt-3 border-t border-divineLine flex justify-between font-semibold">
              <span className="text-divineCream">TOTAL</span>
              <span className="text-divineGold">{money(price)}</span>
            </div>
          </div>

          <div className="mt-6 flex flex-wrap items-center gap-3">
            <button onClick={() => setStep((s) => Math.max(0, s - 1))} className="btn-ghost" type="button">ATRÁS</button>
            <button onClick={() => setStep((s) => Math.min(3, s + 1))} className="btn-ghost" type="button">SIGUIENTE</button>
            <button onClick={buildAndAdd} className="ml-auto btn-primary" disabled={!valid} style={{ opacity: valid ? 1 : 0.6 }} type="button">
              ARMAR
            </button>
          </div>
        </div>
      );
    }
    // =========================
    // Yogurt Coming Soon
    // =========================
    
    function YogurtComingSoonCard() {
      return (
        <div className="rounded-3xl border border-divineLine2 bg-black/25 p-6 shadow-divine">
          <div className="text-[10px] tracking-[0.35em] text-divineGold/90">GREEK YOGURT</div>
          <div className="mt-2 text-3xl font-semibold">¡MUY PRONTO!</div>
          <p className="mt-3 text-sm text-divineCream/70">
            Estamos preparando esta experiencia para ti.
          </p>
          <div className="mt-5 inline-flex items-center gap-2 rounded-full border border-divineLine2 bg-black/20 px-4 py-2 text-xs tracking-[0.22em] text-divineCream/65">
            YOGURT DE MÁQUINA • NO DISPONIBLE
          </div>
        </div>
      );
    }
    // =========================
    // Panel de Administrador
    // =========================
    function AdminLogin({ onLogin, onClose }) {
      const [pin, setPin] = useState("");
      const handleLogin = () => {
        if (pin === "7777") onLogin(); 
        else alert("PIN incorrecto. Acceso denegado.");
      };
      return (
        <BottomSheet title="ZONA RESTRINGIDA" subtitle="Acceso exclusivo para el equipo de Divinée" onClose={onClose}>
          <div className="space-y-4">
            <input type="password" value={pin} onChange={(e) => setPin(e.target.value)} placeholder="Ingresa el PIN" className="w-full bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-center text-2xl tracking-[0.5em] text-divineGold outline-none focus:border-divineGold transition" />
            <button className="w-full btn-primary" onClick={handleLogin}>ENTRAR AL PANEL</button>
          </div>
        </BottomSheet>
      );
    }

function AdminDashboard({ onClose, supabaseClient }) {
      const [orders, setOrders] = useState([]);
      const [disabledItems, setDisabledItems] = useState([]);
      const [loading, setLoading] = useState(true);
      const [tab, setTab] = useState('orders'); 
      const [searchCode, setSearchCode] = useState('');
      const [invoiceOrder, setInvoiceOrder] = useState(null);
      const [isStoreOpen, setIsStoreOpen] = useState(true);

      useEffect(() => { fetchData(); }, []);

      const fetchData = async () => {
        setLoading(true);
        const [ordersRes, invRes, storeRes] = await Promise.all([
          supabaseClient.from('orders').select('*').order('created_at', { ascending: false }),
          supabaseClient.from('disabled_ingredients').select('id'),
          supabaseClient.from('store_settings').select('is_open').eq('id', 'divinee').single()
        ]);
        if (ordersRes.data) setOrders(ordersRes.data);
        if (invRes.data) setDisabledItems(invRes.data.map(i => i.id));
        if (storeRes.data) setIsStoreOpen(storeRes.data.is_open);
        setLoading(false);
      };

      const toggleStore = async () => {
        const newVal = !isStoreOpen;
        setIsStoreOpen(newVal);
        await supabaseClient.from('store_settings').update({ is_open: newVal }).eq('id', 'divinee');
      };

      const updateStatus = async (id, newStatus) => {
        const { error } = await supabaseClient.from('orders').update({ status: newStatus }).eq('id', id);
        if (!error) setOrders(orders.map(o => o.id === id ? { ...o, status: newStatus } : o));
      };

      const toggleIngredient = async (id, isCurrentlyDisabled) => {
        if (isCurrentlyDisabled) {
          await supabaseClient.from('disabled_ingredients').delete().eq('id', id);
          setDisabledItems(prev => prev.filter(i => i !== id));
        } else {
          await supabaseClient.from('disabled_ingredients').insert([{ id }]);
          setDisabledItems(prev => [...prev, id]);
        }
      };

      const formatPhoneForWa = (phone) => {
        let cleaned = phone.replace(/\D/g, ''); 
        if (cleaned.startsWith('0')) cleaned = '58' + cleaned.substring(1); 
        else if (!cleaned.startsWith('58')) cleaned = '58' + cleaned; 
        return cleaned;
      };

      const handleSearchInvoice = (e) => {
        e?.preventDefault();
        const found = orders.find(o => o.tracking_code.toUpperCase() === searchCode.toUpperCase());
        if (found) setInvoiceOrder(found);
      };

      const today = new Date(); today.setHours(0,0,0,0);
      const todayOrders = orders.filter(o => new Date(o.created_at) >= today && o.status !== 'Cancelado');
      const todaySales = todayOrders.reduce((acc, o) => acc + o.total_usd, 0);

      const statusColors = { 'Pendiente': 'text-red-400 border-red-400/30', 'Preparando': 'text-yellow-400 border-yellow-400/30', 'En camino': 'text-blue-400 border-blue-400/30', 'Listo para retirar': 'text-purple-400 border-purple-400/30', 'Entregado': 'text-green-400 border-green-400/30', 'Cancelado': 'text-gray-400 border-gray-400/30' };

      const handlePrintTicket = () => {
        const content = document.getElementById("invoice-print-area").innerHTML;
        const printWindow = window.open('', '', 'width=600,height=800');
        printWindow.document.write(`
          <html>
            <head>
              <title>Ticket Divinée - ${invoiceOrder.tracking_code}</title>
              <style>
                @page { margin: 0; }
                body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #000; background: #f4f4f4; margin: 0; padding: 20px; display: flex; justify-content: center; }
                .ticket-container { width: 100%; max-width: 340px; background: #fff; padding: 30px 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 6px solid #000; }
                .text-center { text-align: center; } .text-right { text-align: right; }
                .font-bold { font-weight: 800; } .font-semibold { font-weight: 600; }
                .flex { display: flex; justify-content: space-between; align-items: flex-start; }
                .mb-6 { margin-bottom: 24px; } .mb-8 { margin-bottom: 32px; } .mb-3 { margin-bottom: 12px; }
                .mt-1 { margin-top: 4px; } .mt-2 { margin-top: 8px; } .mt-3 { margin-top: 12px; }
                .pb-6 { padding-bottom: 24px; border-bottom: 2px dashed #ccc; }
                .py-4 { padding-top: 16px; padding-bottom: 16px; border-bottom: 2px dashed #ccc; }
                .pl-4 { padding-left: 16px; }
                .text-xs { font-size: 12px; color: #555; } .text-sm { font-size: 14px; }
                .text-base { font-size: 16px; color: #000; } .text-2xl { font-size: 24px; letter-spacing: 0.1em; color: #000; }
                h2, p { margin: 0; }
                .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
                .space-y-1 > * { margin-bottom: 6px; display: block; }
                @media print { body { background: white; padding: 0; display: block; } .ticket-container { box-shadow: none; border-radius: 0; margin: 0 auto; max-width: 80mm; padding: 10px; border-top: 2px solid #000; page-break-inside: avoid; } .pb-6, .py-4 { border-bottom-color: #000; } .text-xs { color: #000; } }
              </style>
            </head>
            <body onload="setTimeout(function(){ window.print(); window.close(); }, 400)">
              <div class="ticket-container">${content}</div>
            </body>
          </html>
        `);
        printWindow.document.close();
      };

      return (
        <motion.div className="fixed inset-0 z-[60] bg-divineBg overflow-y-auto text-divineCream" initial={{ opacity: 0, y: 50 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 50 }}>
          <div className="sticky top-0 z-20 bg-black/90 backdrop-blur">
            <div className="border-b border-divineLine2 px-4 py-4 flex flex-wrap justify-between items-center gap-3">
              <div><div className="text-[10px] tracking-[0.35em] text-divineGold/90">PANEL DE CONTROL</div><h2 className="text-xl font-semibold text-white">Gestión Divinée</h2></div>
              <div className="flex gap-2"><button onClick={fetchData} className="btn-ghost px-3 py-2">↻ ACTUALIZAR</button><button onClick={onClose} className="btn-primary px-3 py-2">CERRAR PANEL</button></div>
            </div>
            <div className="flex gap-4 px-4 border-b border-divineLine2/50 overflow-x-auto mobile-scroll">
              <button onClick={() => setTab('orders')} className={`py-3 text-xs tracking-widest whitespace-nowrap transition-colors ${tab === 'orders' ? 'text-divineGold border-b-2 border-divineGold' : 'text-divineCream/50 hover:text-divineCream'}`}>PEDIDOS</button>
              <button onClick={() => setTab('inventory')} className={`py-3 text-xs tracking-widest whitespace-nowrap transition-colors ${tab === 'inventory' ? 'text-divineGold border-b-2 border-divineGold' : 'text-divineCream/50 hover:text-divineCream'}`}>INVENTARIO</button>
              <button onClick={() => setTab('invoice')} className={`py-3 text-xs tracking-widest whitespace-nowrap transition-colors ${tab === 'invoice' ? 'text-divineGold border-b-2 border-divineGold' : 'text-divineCream/50 hover:text-divineCream'}`}>FACTURACIÓN</button>
            </div>
          </div>

          <div className="p-4 max-w-6xl mx-auto space-y-4 pb-20">
            {loading ? <div className="text-center py-10 text-divineCream/50">Cargando datos...</div> : 
             tab === 'orders' ? (
              <>
                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                  <div className="bg-divinePanel border border-divineLine2 rounded-2xl p-4 shadow-divine text-center"><div className="text-[10px] tracking-[0.2em] text-divineCream/50 mb-1">VENTAS HOY</div><div className="text-2xl font-bold text-divineGold">{money(todaySales)}</div></div>
                  <div className="bg-divinePanel border border-divineLine2 rounded-2xl p-4 shadow-divine text-center"><div className="text-[10px] tracking-[0.2em] text-divineCream/50 mb-1">PEDIDOS HOY</div><div className="text-2xl font-bold text-divineGold">{todayOrders.length}</div></div>
                  <div className="col-span-2 md:col-span-1 bg-divinePanel border border-divineLine2 rounded-2xl p-4 shadow-divine flex flex-col items-center justify-center"><div className="text-[10px] tracking-[0.2em] text-divineCream/50 mb-2">ESTADO DE LA TIENDA</div><button onClick={toggleStore} className={`w-full text-sm font-bold tracking-widest py-2 rounded-xl border transition-colors ${isStoreOpen ? 'bg-green-500/20 text-green-400 border-green-500/50 hover:bg-green-500/30' : 'bg-red-500/20 text-red-400 border-red-500/50 hover:bg-red-500/30'}`}>{isStoreOpen ? '🟢 ABIERTO' : '🔴 CERRADA'}</button></div>
                </div>
                {orders.length === 0 ? <div className="text-center py-10 text-divineCream/50">No hay pedidos registrados aún.</div> :
                orders.map(o => (
                  <div key={o.id} className="rounded-2xl border border-divineLine bg-divinePanel p-5 flex flex-col md:flex-row gap-5 justify-between shadow-divine mb-4">
                    <div className="flex-1"><div className="flex flex-wrap items-center gap-3 mb-3"><span className="text-lg font-bold text-divineGold">{o.tracking_code}</span><span className="text-xs text-divineCream/50 border border-divineLine px-2 py-1 rounded-full">{new Date(o.created_at).toLocaleString('es-VE')}</span></div><div className="text-sm text-divineCream/90 mb-1"><span className="text-divineCream/50">Cliente:</span> {o.customer_name} • <a href={`https://wa.me/${formatPhoneForWa(o.phone)}?text=${encodeURIComponent(`Hola ${o.customer_name}, tu pedido ${o.tracking_code} ya está en proceso. Divinée🍔✨`)}`} target="_blank" rel="noopener noreferrer" className="ml-1 text-divineGold hover:underline">📞 {o.phone}</a></div><div className="text-sm text-divineCream/90 mb-3"><span className="text-divineCream/50">Dir:</span> {o.address}</div><div className="text-xs text-divineCream/70 bg-black/40 p-3 rounded-xl border border-divineLine2/30"><div className="font-semibold text-divineCream mb-1">CARRITO:</div>{o.items.map((it, i) => <div key={i}>• {it.qty}x {it.name}</div>)}{o.notes && <div className="mt-2 text-divineGold/90">📝 Nota: {o.notes}</div>}</div></div>
                    <div className="flex flex-col items-start md:items-end justify-between min-w-[220px] bg-black/20 p-4 rounded-xl border border-divineLine2/20"><div className="w-full text-left md:text-right"><div className="text-xs text-divineCream/50">TOTAL PAGADO</div><div className="text-2xl font-bold text-divineGold">{money(o.total_usd)}</div><div className="text-xs text-divineCream/60 mt-1">Ref: <span className="text-divineCream tracking-widest">{o.payment_ref}</span></div>{o.bcv_rate && <div className="text-[10px] text-divineCream/40 mt-1">Tasa: {o.bcv_rate}</div>}</div><div className="w-full mt-4"><div className="text-[10px] tracking-[0.2em] text-divineCream/50 mb-1 text-left md:text-right">ESTATUS ACTUAL</div><select value={o.status} onChange={(e) => updateStatus(o.id, e.target.value)} className={`w-full bg-black/80 border rounded-xl px-3 py-2 text-sm font-semibold outline-none cursor-pointer ${statusColors[o.status] || 'text-divineCream border-divineLine'}`}><option value="Pendiente">Pendiente</option><option value="Preparando">Preparando</option><option value="En camino">En camino</option><option value="Listo para retirar">Listo para retirar</option><option value="Entregado">Entregado</option><option value="Cancelado">Cancelado</option></select><button onClick={() => { setSearchCode(o.tracking_code); setInvoiceOrder(o); setTab('invoice'); }} className="mt-3 text-[11px] tracking-widest text-divineCream/50 hover:text-divineGold transition flex items-center gap-1 md:justify-end w-full">📄 GENERAR FACTURA</button></div></div>
                  </div>
                ))}
              </>
             ) : tab === 'inventory' ? (
              <div className="space-y-8">
                <div className="bg-divineLine2/10 border border-divineLine2/30 p-4 rounded-2xl text-sm text-divineCream/80">Toca un producto o ingrediente para marcarlo como <b>AGOTADO</b>.</div>
                
                <div><h3 className="text-xs tracking-[0.2em] text-divineGold mb-3 uppercase">MENÚ: HAMBURGUESAS</h3><div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">{burgers.map(item => { const isOff = disabledItems.includes(item.id); return (<button key={item.id} onClick={() => toggleIngredient(item.id, isOff)} className={`p-3 rounded-xl border text-left transition ${isOff ? 'bg-red-500/10 border-red-500/30' : 'bg-divinePanel border-divineLine hover:border-divineGold/50'}`}><div className={`font-semibold text-sm ${isOff ? 'text-red-400 line-through' : 'text-divineCream'}`}>{item.name}</div><div className="text-[10px] mt-1 text-divineCream/50">{isOff ? '🔴 AGOTADO' : '🟢 DISPONIBLE'}</div></button>) })}</div></div>
                <div><h3 className="text-xs tracking-[0.2em] text-divineGold mb-3 uppercase mt-6">MENÚ: POSTRES</h3><div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">{desserts.map(item => { const isOff = disabledItems.includes(item.id); return (<button key={item.id} onClick={() => toggleIngredient(item.id, isOff)} className={`p-3 rounded-xl border text-left transition ${isOff ? 'bg-red-500/10 border-red-500/30' : 'bg-divinePanel border-divineLine hover:border-divineGold/50'}`}><div className={`font-semibold text-sm ${isOff ? 'text-red-400 line-through' : 'text-divineCream'}`}>{item.name}</div><div className="text-[10px] mt-1 text-divineCream/50">{isOff ? '🔴 AGOTADO' : '🟢 DISPONIBLE'}</div></button>) })}</div></div>
                
                {Object.entries(BURGER_CATALOG).map(([category, items]) => (<div key={category}><h3 className="text-xs tracking-[0.2em] text-divineGold mb-3 uppercase mt-6">ATELIER: {category}</h3><div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">{items.map(item => { if(item.id === 'none') return null; const isOff = disabledItems.includes(item.id); return (<button key={item.id} onClick={() => toggleIngredient(item.id, isOff)} className={`p-3 rounded-xl border text-left transition ${isOff ? 'bg-red-500/10 border-red-500/30' : 'bg-divinePanel border-divineLine hover:border-divineGold/50'}`}><div className={`font-semibold text-sm ${isOff ? 'text-red-400 line-through' : 'text-divineCream'}`}>{item.name}</div><div className="text-[10px] mt-1 text-divineCream/50">{isOff ? '🔴 AGOTADO' : '🟢 DISPONIBLE'}</div></button>) })}</div></div>))}
              </div>
             ) : (
              <div className="max-w-md mx-auto">
                <form onSubmit={handleSearchInvoice} className="flex gap-2 mb-6"><input type="text" value={searchCode} onChange={(e) => setSearchCode(e.target.value)} placeholder="Código (Ej: #DIV-1234)" className="flex-1 bg-black/40 border border-divineLine2 rounded-xl px-4 py-3 text-sm text-divineCream outline-none focus:border-divineGold transition uppercase tracking-widest" /><button type="submit" className="btn-primary px-6">BUSCAR</button></form>
                {invoiceOrder ? (
                  <><div id="invoice-print-area" className="bg-white text-black p-6 md:p-8 rounded-2xl shadow-xl font-mono text-sm"><div className="text-center mb-6 border-b-2 border-dashed border-black/20 pb-6"><h2 className="text-2xl font-bold tracking-widest">{BRAND_NAME.toUpperCase()}</h2><p className="text-xs mt-1 text-gray-600">GOURMET BAR</p><p className="text-xs text-gray-600 mt-1">RIF: V-30158858-1</p></div><div className="mb-6 space-y-1 text-xs"><div className="flex"><span>TICKET:</span> <strong className="text-base">{invoiceOrder.tracking_code}</strong></div><div className="flex"><span>FECHA:</span> <span>{new Date(invoiceOrder.created_at).toLocaleString('es-VE')}</span></div><div className="flex mt-3"><span>CLIENTE:</span> <span className="font-bold uppercase text-right truncate">{invoiceOrder.customer_name}</span></div><div className="flex"><span>TLF:</span> <span>{invoiceOrder.phone}</span></div></div><div className="mb-6 border-t-2 border-b-2 border-dashed border-black/20 py-4"><div className="flex font-bold mb-3 text-xs"><span>CANT DESCRIPCIÓN</span><span>TOTAL</span></div>{invoiceOrder.items.map((it, i) => (<div key={i} className="mb-3 text-xs"><div className="flex font-semibold"><span>{it.qty}x {it.name.replace('Hamburguesa Divinée (Atelier)', 'Atelier')}</span><span>{money(it.price * it.qty)}</span></div>{it.meta && (<div className="text-xs text-gray-500 pl-4 mt-1 space-y-1">{Object.entries(it.meta).map(([k,v]) => <div key={k}>- {k}: {Array.isArray(v) ? v.join(", ") : String(v)}</div>)}</div>)}</div>))}</div><div className="mb-8 space-y-1"><div className="flex text-base font-bold"><span>TOTAL USD:</span><span>{money(invoiceOrder.total_usd)}</span></div>{invoiceOrder.bcv_rate && (<div className="flex text-xs text-gray-500 font-bold"><span>TOTAL BCV (TASA {invoiceOrder.bcv_rate}):</span><span>{(invoiceOrder.total_usd * invoiceOrder.bcv_rate).toFixed(2)} Bs</span></div>)}<div className="flex text-xs text-gray-400 mt-2"><span>REF PAGO:</span><span>{invoiceOrder.payment_ref}</span></div></div><div className="text-center text-xs text-gray-600 font-bold space-y-1"><p>¡GRACIAS POR SU COMPRA!</p><p>Exquisito. Divino. Divinée🍔✨</p></div></div><button onClick={handlePrintTicket} className="mt-8 w-full bg-black text-white py-4 rounded-xl font-sans font-bold tracking-widest hover:bg-gray-800 transition shadow-lg">🖨️ IMPRIMIR TICKET</button></>
                ) : (<div className="text-center py-10 text-divineCream/40 text-sm border border-dashed border-divineLine2 rounded-2xl">Ingresa el código arriba o selecciona un pedido de la lista para generar su factura.</div>)}
              </div>
             )
            }
          </div>
        </motion.div>
      );
    }
  
// =========================
    // Notificaciones Premium (Toasts)
    // =========================
    window.showToast = (msg, icon = '✨') => window.dispatchEvent(new CustomEvent('add-toast', { detail: { msg, icon } }));

    function ToastContainer() {
      const [toasts, setToasts] = useState([]);
      useEffect(() => {
        const handleToast = (e) => {
          const id = Date.now() + Math.random();
          setToasts(prev => [...prev, { id, ...e.detail }]);
          setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3500);
        };
        window.addEventListener('add-toast', handleToast);
        return () => window.removeEventListener('add-toast', handleToast);
      }, []);

      return (
        <div className="fixed top-6 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none px-4">
          <AnimatePresence>
            {toasts.map(t => (
              <motion.div key={t.id} initial={{ opacity: 0, y: -30, scale: 0.8 }} animate={{ opacity: 1, y: 0, scale: 1 }} exit={{ opacity: 0, y: -20, scale: 0.8 }} className="bg-black/85 backdrop-blur-md border border-divineLine2 shadow-glow text-divineCream px-5 py-3 rounded-full text-[11px] sm:text-xs tracking-widest flex items-center gap-3">
                <span className="text-lg">{t.icon}</span> {t.msg}
              </motion.div>
            ))}
          </AnimatePresence>
        </div>
      );
    }

    // =========================
    // Pantalla de Carga de Lujo (Preloader)
    // =========================
    function Preloader({ onComplete }) {
      useEffect(() => {
        const t = setTimeout(onComplete, 2200); // La pantalla dura 2.2 segundos
        return () => clearTimeout(t);
      }, [onComplete]);
      return (
        <motion.div initial={{ opacity: 1 }} exit={{ opacity: 0 }} transition={{ duration: 0.8, ease: "easeInOut" }} className="fixed inset-0 z-[200] bg-divineBg flex flex-col items-center justify-center">
          <div className="relative flex items-center justify-center">
            <motion.div animate={{ rotate: 360 }} transition={{ duration: 6, repeat: Infinity, ease: "linear" }} className="absolute -inset-6 rounded-full border border-dashed border-divineGold/30"></motion.div>
            <motion.div animate={{ rotate: -360 }} transition={{ duration: 10, repeat: Infinity, ease: "linear" }} className="absolute -inset-8 rounded-full border border-divineLine2/20"></motion.div>
            <motion.img initial={{ opacity: 0, scale: 0.7 }} animate={{ opacity: 1, scale: 1 }} transition={{ duration: 1 }} src={LOGO_LOCAL} onError={(e) => e.target.src=LOGO_REMOTE} className="w-20 h-20 object-contain rounded-2xl border border-divineLine2 p-2 shadow-glow relative z-10 bg-black/50 backdrop-blur" />
          </div>
          <motion.div initial={{ width: 0 }} animate={{ width: 140 }} transition={{ duration: 1.8, ease: "easeInOut" }} className="h-[2px] bg-divineGold mt-10 rounded-full shadow-glow"></motion.div>
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} transition={{ delay: 0.6 }} className="mt-4 text-[10px] tracking-[0.4em] text-divineCream/50">PREPARANDO LA EXPERIENCIA</motion.div>
        </motion.div>
      );
    }

    // =========================
    // App Base
    // =========================
function App() {
      useSpotlight();
      const refs = { burgers: useRef(null), desserts: useRef(null), yogurt: useRef(null), atelier: useRef(null) };
      const [activeBurger, setActiveBurger] = useState(null);
      const [cartOpen, setCartOpen] = useState(false);
      
      const [cartItems, setCartItems] = useState(() => {
        try { const guardado = localStorage.getItem('divinee_cart'); return guardado ? JSON.parse(guardado) : []; } catch (e) { return []; }
      });

      const [bcvRate, setBcvRate] = useState(null);
      const [trackingModalOpen, setTrackingModalOpen] = useState(false);
      const [adminModalOpen, setAdminModalOpen] = useState(false);
      const [isAdminLogged, setIsAdminLogged] = useState(false);
      const [appLoaded, setAppLoaded] = useState(false);
      
      const [isStoreOpen, setIsStoreOpen] = useState(true);
      const [disabledItems, setDisabledItems] = useState([]);

      const cartCount = useMemo(() => cartItems.reduce((acc, it) => acc + it.qty, 0), [cartItems]);
      const cartTotal = useMemo(() => cartItems.reduce((acc, it) => acc + it.price * it.qty, 0), [cartItems]);

      useEffect(() => { localStorage.setItem('divinee_cart', JSON.stringify(cartItems)); }, [cartItems]);

      useEffect(() => {
        fetch("https://ve.dolarapi.com/v1/dolares/oficial").then(res => res.json()).then(data => setBcvRate(data.promedio)).catch(err => setBcvRate(60.00)); 
        
        const checkStoreStatus = async () => {
          if (window.supabase) {
            const { data } = await supabaseClient.from('store_settings').select('is_open').eq('id', 'divinee').single();
            if (data) setIsStoreOpen(data.is_open);
            
            const { data: invData } = await supabaseClient.from('disabled_ingredients').select('id');
            if (invData) setDisabledItems(invData.map(i => i.id));
          }
        };
        checkStoreStatus();
        const interval = setInterval(checkStoreStatus, 30000);
        return () => clearInterval(interval);
      }, []);

      function scrollTo(key) { refs[key]?.current?.scrollIntoView({ behavior: "smooth", block: "start" }); }
      
      function addToCart(item) {
        if (!isStoreOpen) { window.showToast("CERRADO POR HOY 🚫", '🚫'); return; }
        if (disabledItems.includes(item.id)) { window.showToast("Este producto está agotado 🚫", '🚫'); return; }

        window.showToast(`${item.name} añadido`, '🍔');
        setCartItems((prev) => {
          const idx = prev.findIndex((p) => p.id === item.id);
          if (idx >= 0) { const copy = [...prev]; copy[idx] = { ...copy[idx], qty: copy[idx].qty + 1 }; return copy; }
          return [...prev, { ...item, qty: 1 }];
        });
      }
      
      function updateQty(id, qty) { setCartItems((prev) => prev.map((p) => (p.id === id ? { ...p, qty } : p)).filter((p) => p.qty > 0)); }

      return (
        <div className="min-h-screen relative z-[1]">
          
          <AnimatePresence>
            {!isStoreOpen && (
              <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -20 }} className="bg-red-500/90 text-white text-center py-2 text-[10px] md:text-xs font-bold tracking-widest fixed top-0 w-full z-[300] backdrop-blur shadow-glow">
                LOCAL CERRADO POR EL MOMENTO - NO SE RECIBEN PEDIDOS
              </motion.div>
            )}
          </AnimatePresence>

          <ToastContainer />
          <AnimatePresence>{!appLoaded && <Preloader onComplete={() => setAppLoaded(true)} />}</AnimatePresence>
          <Header onNavigate={scrollTo} onOpenCart={() => setCartOpen(true)} cartCount={cartCount} onOpenAdmin={() => setAdminModalOpen(true)} />
          
          <main className="mx-auto max-w-6xl px-4 pb-28 pt-28 md:pt-28 md:px-6">
            <motion.section initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.6, ease: [0.2, 0.8, 0.2, 1] }} className="mb-8 md:mb-14">
              <div className="rounded-3xl hero-grid shadow-divine p-5 md:p-10 relative overflow-hidden">
                <div className="absolute inset-0 pointer-events-none">
                  {[...Array(8)].map((_, i) => (
                    <motion.div key={i} className="absolute w-1 h-1 bg-divineGold rounded-full shadow-glow blur-[1px]" animate={{ y: [0, -60, 0], opacity: [0, 0.8, 0], scale: [0.5, 1.5, 0.5] }} transition={{ duration: 4 + Math.random() * 3, repeat: Infinity, delay: Math.random() * 2 }} style={{ left: `${10 + Math.random() * 80}%`, top: `${20 + Math.random() * 60}%` }} />
                  ))}
                </div>
                <div className="relative z-10">
                  <div className="flex justify-between items-start"><p className="mb-3 text-xs tracking-[0.35em] text-divineGold/90">{BRAND_NAME.toUpperCase()} • GOURMET BAR</p>{bcvRate && <div className="text-[10px] tracking-[0.28em] text-divineCream/50 border border-divineLine2/30 rounded-full px-3 py-1 bg-black/40">TASA BCV: {bcvRate} Bs</div>}</div>
                  <h1 className="text-3xl font-semibold leading-tight md:text-6xl"><span className="bg-gradient-to-r from-divineCream via-divineCream to-divineGold bg-clip-text text-transparent">Hamburguesas, postres y yogurt griego</span> con estética de lujo.</h1>
                  <p className="mt-3 max-w-2xl text-sm text-divineCream/75 md:text-base">Explora el menú y arma tu burger con un configurador premium.</p>
                  <div className="mt-5 flex flex-col sm:flex-row flex-wrap gap-3">
                    <button className="btn-primary w-full sm:w-auto" onClick={() => scrollTo("burgers")} type="button">Explorar menú</button>
                    <button className="btn-ghost w-full sm:w-auto" onClick={() => setTrackingModalOpen(true)} type="button">Rastrear Pedido</button>
                  </div>
                </div>
              </div>
            </motion.section>
            
            <section ref={refs.burgers} className="scroll-mt-32"><SectionShell eyebrow="COLECCIÓN DIVINÉE" title="Hamburguesas" subtitle="Exquisito. Divino. Divinée🍔✨."><ProductShowcase items={burgers} badge="VER 360°" onOpen={setActiveBurger} onAdd={addToCart} disabledItems={disabledItems} /></SectionShell></section>
            <section ref={refs.desserts} className="scroll-mt-32"><SectionShell eyebrow="EXQUISITE DESSERTS" title="Postres" subtitle="Selección corta, elegante."><ProductShowcase items={desserts} badge="PATISSERIE" onOpen={(p) => addToCart({ ...p, qty: 1 })} onAdd={addToCart} disabledItems={disabledItems} /></SectionShell></section>
            
            <section ref={refs.yogurt} className="scroll-mt-32"><SectionShell eyebrow="GREEK YOGURT DE MÁQUINA" title="Yogurt" subtitle="Sección desactivada temporalmente."><YogurtComingSoonCard /></SectionShell></section>
            <section ref={refs.atelier} className="scroll-mt-32"><SectionShell eyebrow="ATELIER" title="Arma tu Hamburguesa" subtitle="Configurador en vivo, agrega ingredientes y verás cómo caen."><BurgerBuilder onAddToCart={addToCart} /></SectionShell></section>
          </main>

          <div className="md:hidden"><CartButton cartCount={cartCount} onClick={() => setCartOpen(true)} /></div>
          
          <a href="https://wa.me/584126835635?text=Hola%20Divin%C3%A9e%2C%20tengo%20una%20duda%20con%20mi%20pedido..." target="_blank" rel="noopener noreferrer" className="fixed z-40 bottom-[calc(1.1rem+env(safe-area-inset-bottom))] left-[calc(1.1rem+env(safe-area-inset-left))] rounded-2xl border border-[#25D366]/50 bg-black/60 px-4 py-3 shadow-glow backdrop-blur hover:bg-[#25D366]/20 transition flex items-center gap-3"><span className="text-xl leading-none">💬</span><span className="text-xs tracking-[0.2em] text-[#25D366] font-semibold hidden sm:inline">AYUDA</span></a>
          
          <AnimatePresence>{cartOpen && <CartDrawer items={cartItems} total={cartTotal} bcvRate={bcvRate} onClose={() => setCartOpen(false)} onQty={updateQty} onClearCart={() => setCartItems([])} />}</AnimatePresence>
          <AnimatePresence>{!!activeBurger && <ProductModal product={activeBurger} onClose={() => setActiveBurger(null)} onAdd={() => addToCart({ id: activeBurger.id, name: activeBurger.name, price: activeBurger.price })} />}</AnimatePresence>
          <AnimatePresence>{trackingModalOpen && <TrackingModal onClose={() => setTrackingModalOpen(false)} supabaseClient={supabaseClient} />}</AnimatePresence>
          <AnimatePresence>
            {adminModalOpen && !isAdminLogged && <AdminLogin onLogin={() => setIsAdminLogged(true)} onClose={() => setAdminModalOpen(false)} />}
            {adminModalOpen && isAdminLogged && <AdminDashboard supabaseClient={supabaseClient} onClose={() => setAdminModalOpen(false)} />}
          </AnimatePresence>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById("root")); root.render(<App />);
  </script>
</body>
</html>











































